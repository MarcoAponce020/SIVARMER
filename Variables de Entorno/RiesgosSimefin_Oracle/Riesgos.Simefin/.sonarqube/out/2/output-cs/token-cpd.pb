ฟ
ฟD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Infrastructure.Oracle\Helpers\OracleConnectionHelper.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Infrastructure (
.( )
Oracle) /
./ 0
Helpers0 7
{ 
public		 

static		 
class		 "
OracleConnectionHelper		 .
{

 
private 
static 
IConfiguration %
?% &
_configuration' 5
;5 6
public 
static 
void 

Initialize %
(% &
IConfiguration& 4
configuration5 B
)B C
{ 	
_configuration 
= 
configuration *
;* +
} 	
public 
static 
OracleConnection &
GetConnection' 4
(4 5
)5 6
{ 	
string 
environmentVariable &
=' (
_configuration) 7
!7 8
.8 9

GetSection9 C
(C D
$strD Y
)Y Z
.Z [
Value[ `
!` a
;a b
string $
environmentVariableValue +
=, -
Environment. 9
.9 :"
GetEnvironmentVariable: P
(P Q
environmentVariableQ d
)d e
!e f
;f g
if 
( 
! 
string 
. 
IsNullOrEmpty %
(% &$
environmentVariableValue& >
)> ?
)? @
{ 
var 
data 
= 
JsonConvert &
.& '
DeserializeObject' 8
<8 9 
EnvironmentVariables9 M
>M N
(N O$
environmentVariableValueO g
!g h
)h i
;i j
string 
connectionString '
=( )
_configuration* 8
!8 9
.9 :

GetSection: D
(D E
$strE X
)X Y
.Y Z

GetSectionZ d
(d e
$stre u
)u v
.v w
Valuew |
!| }
;} ~
string !
valueConnectionString ,
=- .
string/ 5
.5 6
Format6 <
(< =
connectionString= M
,M N
dataO S
!S T
.T U
ServerNameOrIPU c
,c d
datae i
.i j
Portj n
,n o
datap t
.t u
Schemeu {
,{ |
data	} 
.
 
UserId
 
,
 
data
 
.
 
Password
 
)
 
;
 
var 

connection 
=  
new! $
OracleConnection% 5
(5 6!
valueConnectionString6 K
)K L
;L M
return 

connection !
;! "
} 
return   
new   
OracleConnection   '
(  ' (
)  ( )
;  ) *
}!! 	
}$$ 
}&& ร/
ผD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Infrastructure.Oracle\Repositories\UserRepository.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Infrastructure (
.( )
Oracle) /
./ 0
Repositories0 <
{		 
public 

class 
UserRepository 
:  !
IUserRepository" 1
{ 
private 
readonly 
IConfiguration '
_configuration( 6
;6 7
private 
readonly 
string 
?  
_usersTableName! 0
=1 2
string3 9
.9 :
Empty: ?
;? @
public 
UserRepository 
( 
IConfiguration ,
configuration- :
): ;
{ 	
_configuration 
= 
configuration *
;* +
_usersTableName 
= 
_configuration ,
., -

GetSection- 7
(7 8
$str8 H
)H I
.I J

GetSectionJ T
(T U
$strU a
)a b
.b c
Valuec h
!h i
;i j
} 	
public 
async 
Task 
< 
int 
> 
AddAsync '
(' (
Usuario( /
entity0 6
)6 7
{   	
using!! 
(!! 
var!! 

connection!! !
=!!" #"
OracleConnectionHelper!!$ :
.!!: ;
GetConnection!!; H
(!!H I
)!!I J
)!!J K
{"" 
await## 

connection##  
.##  !
	OpenAsync##! *
(##* +
)##+ ,
;##, -
var$$ 

parameters$$ 
=$$  
new$$! $
{%% 

p_UserName'' 
=''  
entity''! '
.''' (
UserName''( 0
,''0 1
p_Nombre(( 
=(( 
entity(( %
.((% &
Nombre((& ,
,((, -

p_Password)) 
=))  
entity))! '
.))' (
Password))( 0
,))0 1
p_Rol** 
=** 
entity** "
.**" #
Rol**# &
}++ 
;++ 
var,, 
query,, 
=,, 
@$",, 
$str,, +
{,,+ ,
_usersTableName,,, ;
},,; <
$str,-< P
"--P Q
;--Q R
var.. 
rowsAffected..  
=..! "
await..# (

connection..) 3
...3 4
ExecuteAsync..4 @
(..@ A
query..A F
,..F G

parameters..H R
)..R S
;..S T
return// 
rowsAffected// #
;//# $
}00 
}11 	
public33 
Task33 
<33 
bool33 
>33 
DeleteAsync33 %
(33% &
int33& )
id33* ,
)33, -
{44 	
throw55 
new55 #
NotImplementedException55 -
(55- .
)55. /
;55/ 0
}66 	
public<< 
async<< 
Task<< 
<<< 
IEnumerable<< %
<<<% &
Usuario<<& -
><<- .
><<. /
GetAllAsync<<0 ;
(<<; <
)<<< =
{== 	
using>> 
(>> 
OracleConnection>> #

connection>>$ .
=>>/ 0"
OracleConnectionHelper>>1 G
.>>G H
GetConnection>>H U
(>>U V
)>>V W
)>>W X
{?? 
await@@ 

connection@@  
.@@  !
	OpenAsync@@! *
(@@* +
)@@+ ,
;@@, -
stringAA 
strQueryAA 
=AA  !
@$"AA" %
$strAA% U
{AAU V
_usersTableNameAAV e
}AAe f
"AAf g
;AAg h
returnBB 
awaitBB 

connectionBB '
.BB' (

QueryAsyncBB( 2
<BB2 3
UsuarioBB3 :
>BB: ;
(BB; <
strQueryBB< D
)BBD E
;BBE F
}CC 
}DD 	
publicKK 
asyncKK 
TaskKK 
<KK 
UsuarioKK !
>KK! "
GetByIdAsyncKK# /
(KK/ 0
intKK0 3
userIdKK4 :
)KK: ;
{LL 	
usingMM 
(MM 
OracleConnectionMM #

connectionMM$ .
=MM/ 0"
OracleConnectionHelperMM1 G
.MMG H
GetConnectionMMH U
(MMU V
)MMV W
)MMW X
{NN 
awaitOO 

connectionOO  
.OO  !
	OpenAsyncOO! *
(OO* +
)OO+ ,
;OO, -
varPP 

parametersPP 
=PP  
newPP! $
{PP% &
p_IdPP' +
=PP, -
userIdPP. 4
}PP5 6
;PP6 7
stringQQ 
strQueryQQ 
=QQ  !
@$"QQ" %
$strQQ% U
{QQU V
_usersTableNameQQV e
}QQe f
$strQQf w
"QQw x
;QQx y
varRR 
userRR 
=RR 
awaitRR  

connectionRR! +
.RR+ ,$
QueryFirstOrDefaultAsyncRR, D
<RRD E
UsuarioRRE L
>RRL M
(RRM N
strQueryRRN V
,RRV W

parametersRRX b
)RRb c
;RRc d
returnTT 
userTT 
!TT 
;TT 
}UU 
}VV 	
publicXX 
TaskXX 
<XX 
boolXX 
>XX 
UpdateAsyncXX %
(XX% &
UsuarioXX& -
entityXX. 4
)XX4 5
{YY 	
throwZZ 
newZZ #
NotImplementedExceptionZZ -
(ZZ- .
)ZZ. /
;ZZ/ 0
}\\ 	
}]] 
}__ 
มD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Infrastructure.Oracle\Repositories\PortfolioRepository.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Infrastructure (
.( )
Oracle) /
./ 0
Repositories0 <
{ 
public 

class 
PortfolioRepository $
:% & 
IPortfolioRepository' ;
{ 
private 
readonly 
IConfiguration '
_configuration( 6
;6 7
private 
readonly 
string 
_portfolioTableName  3
=4 5
string6 <
.< =
Empty= B
;B C
private 
readonly 
string "
_subPortfolioTableName  6
=7 8
string9 ?
.? @
Empty@ E
;E F
private 
readonly 
string 
_historialTableName  3
=4 5
string6 <
.< =
Empty= B
;B C
public 
PortfolioRepository "
(" #
IConfiguration# 1
configuration2 ?
)? @
{ 	
_configuration   
=   
configuration   *
;  * +
_portfolioTableName"" 
=""  !
_configuration""" 0
.""0 1

GetSection""1 ;
(""; <
$str""< L
)""L M
.""M N

GetSection""N X
(""X Y
$str""Y h
)""h i
.""i j
Value""j o
!""o p
;""p q"
_subPortfolioTableName## "
=### $
_configuration##% 3
.##3 4

GetSection##4 >
(##> ?
$str##? O
)##O P
.##P Q

GetSection##Q [
(##[ \
$str##\ n
)##n o
.##o p
Value##p u
!##u v
;##v w
_historialTableName$$ 
=$$  !
_configuration$$" 0
.$$0 1

GetSection$$1 ;
($$; <
$str$$< L
)$$L M
.$$M N

GetSection$$N X
($$X Y
$str$$Y f
)$$f g
.$$g h
Value$$h m
!$$m n
;$$n o
}%% 	
public,, 
async,, 
Task,, 
<,, 
IEnumerable,, %
<,,% &

Portafolio,,& 0
>,,0 1
>,,1 2
GetAllAsync,,3 >
(,,> ?
List,,? C
<,,C D
object,,D J
>,,J K
?,,K L
filters,,M T
=,,U V
null,,W [
),,[ \
{-- 	
using.. 
(.. 
IDbConnection..  

connection..! +
=.., -"
OracleConnectionHelper... D
...D E
GetConnection..E R
(..R S
)..S T
)..T U
{// 

connection11 
.11 
Open11 
(11  
)11  !
;11! "
string22 
strQuery22 
=22  !
string22" (
.22( )
Empty22) .
;22. /
string33 
strWhere33 
=33  !
string33" (
.33( )
Empty33) .
;33. /
int44 
countParameters44 #
=44$ %
$num44& '
;44' (
var55 

filterList55 
=55  
new55! $

Dictionary55% /
<55/ 0
string550 6
,556 7
object558 >
>55> ?
(55? @
)55@ A
{55B C
}55D E
;55E F
if66 
(66 
filters66 
!=66 
null66 #
)66# $
{77 
strWhere88 
=88 
$str88 (
;88( )
foreach99 
(99 
var99  
item99! %
in99& (
filters99) 0
!990 1
)991 2
{:: 
countParameters;; '
+=;;( *
$num;;+ ,
;;;, -
var<< 
props<< !
=<<" #
item<<$ (
.<<( )
GetType<<) 0
(<<0 1
)<<1 2
.<<2 3
GetProperties<<3 @
(<<@ A
)<<A B
;<<B C
var== 
pairs== !
===" #
props==$ )
.==) *
Select==* 0
(==0 1
x==1 2
=>==3 5
x==6 7
.==7 8
Name==8 <
+=== >
$str==? B
+==C D
x==E F
.==F G
GetValue==G O
(==O P
item==P T
,==T U
null==V Z
)==Z [
)==[ \
.==\ ]
ToArray==] d
(==d e
)==e f
;==f g
var>> 
pairDictionary>> *
=>>+ ,
props>>- 2
.>>2 3
ToDictionary>>3 ?
(>>? @
x>>@ A
=>>>B D
x>>E F
.>>F G
Name>>G K
,>>K L
x>>M N
=>>>O Q
x>>R S
.>>S T
GetValue>>T \
(>>\ ]
item>>] a
,>>a b
null>>c g
)>>g h
?>>h i
.>>i j
ToString>>j r
(>>r s
)>>s t
)>>t u
;>>u v
var?? 
	columName?? %
=??& '
pairDictionary??( 6
.??6 7
Keys??7 ;
.??; <
Select??< B
(??B C
x??C D
=>??E G
x??H I
)??I J
.??J K
FirstOrDefault??K Y
(??Y Z
)??Z [
;??[ \
var@@ 
parameterName@@ )
=@@* +
$"@@, .
$str@@. 0
{@@0 1
	columName@@1 :
}@@: ;
"@@; <
;@@< =
ifAA 
(AA 
countParametersAA +
>AA, -
$numAA. /
)AA/ 0
{BB 
strWhereCC $
+=CC% '
$strCC( /
;CC0 1
}DD 
strWhereEE  
+=EE! #
$"EE$ &
$strEE& (
{EE( )
	columNameEE) 2
}EE2 3
$strEE3 7
{EE7 8
parameterNameEE8 E
}EEE F
"EEF G
;EEG H
}FF 

filterListGG 
=GG  
thisGG! %
.GG% &!
GetAnonymusParametersGG& ;
(GG; <
filtersGG< C
)GGC D
;GGD E
strQueryHH 
=HH 
@$"HH "
$strHI" %
{II% &
_portfolioTableNameII& 9
}II9 :
$strII: H
{IIH I"
_subPortfolioTableNameIII _
}II_ `
$str	II` 
"
II 
;
II 
strQueryJJ 
+=JJ 
strWhereJJ  (
;JJ( )
}KK 
elseLL 
{MM 
strQueryNN 
=NN 
@$"NN "
$strNO" %
{OO% &
_portfolioTableNameOO& 9
}OO9 :
$strOO: H
{OOH I"
_subPortfolioTableNameOOI _
}OO_ `
$str	OO` 
"
OO 
;
OO 
}PP 
stringQQ 
strOrderQQ 
=QQ  !
$strQQ" @
;QQ@ A
varRR 

portfoliosRR 
=RR  
awaitRR! &

connectionRR' 1
.RR1 2

QueryAsyncRR2 <
<RR< =

PortafolioRR= G
>RRG H
(RRH I
strQueryRRI Q
+RRR S
strOrderRRT \
,RR\ ]

filterListRR^ h
)RRh i
;RRi j

portfoliosSS 
.SS 
ToListSS !
(SS! "
)SS" #
.SS# $
ForEachSS$ +
(SS+ ,
	portfolioSS, 5
=>SS6 8
{SS9 :
ifTT 
(TT 
	portfolioTT !
!=TT" $
nullTT% )
&&TT* ,
	portfolioTT- 6
.TT6 7

ListaDatosTT7 A
!=TTB D
nullTTE I
)TTI J
{UU 
	portfolioVV !
!VV! "
.VV" #

ListaDatosVV# -
=VV. /
JsonConvertVV0 ;
.VV; <
DeserializeObjectVV< M
<VVM N
ListVVN R
<VVR S
ListaDatosDTOVVS `
>VV` a
>VVa b
(VVb c
	portfolioVVc l
.VVl m

ListaDatosVVm w
!VVw x
)VVx y
;VVy z
}WW 
}XX 
)XX 
;XX 
returnYY 

portfoliosYY !
;YY! "
}ZZ 
}[[ 	
publicbb 
asyncbb 
Taskbb 
<bb 

Portafoliobb $
>bb$ %
GetByIdAsyncbb& 2
(bb2 3
intbb3 6
idbb7 9
)bb9 :
{cc 	
usingdd 
(dd 
OracleConnectiondd #

connectiondd$ .
=dd/ 0"
OracleConnectionHelperdd1 G
.ddG H
GetConnectionddH U
(ddU V
)ddV W
)ddW X
{ee 
awaitff 

connectionff  
.ff  !
	OpenAsyncff! *
(ff* +
)ff+ ,
;ff, -
vargg 

parametersgg 
=gg  
newgg! $
{gg% &
p_Idgg' +
=gg, -
idgg. 0
}gg1 2
;gg2 3
stringhh 
strQueryhh 
=hh  !
@$"hh" %
$strhi% )
{ii) *
_portfolioTableNameii* =
}ii= >
$strii> L
{iiL M"
_subPortfolioTableNameiiM c
}iic d
$strijd >
"jj> ?
;jj? @
varkk 
	portfoliokk 
=kk 
awaitkk  %

connectionkk& 0
.kk0 1$
QueryFirstOrDefaultAsynckk1 I
<kkI J

PortafoliokkJ T
>kkT U
(kkU V
strQuerykkV ^
,kk^ _

parameterskk` j
)kkj k
;kkk l
ifmm 
(mm 
	portfoliomm 
!=mm  
nullmm! %
&&mm& (
	portfoliomm) 2
.mm2 3

ListaDatosmm3 =
!=mm> @
nullmmA E
)mmE F
{nn 
	portfoliooo 
!oo 
.oo 

ListaDatosoo )
=oo* +
JsonConvertoo, 7
.oo7 8
DeserializeObjectoo8 I
<ooI J
ListooJ N
<ooN O
ListaDatosDTOooO \
>oo\ ]
>oo] ^
(oo^ _
	portfoliooo_ h
.ooh i

ListaDatosooi s
!oos t
)oot u
;oou v
}pp 
returnrr 
	portfoliorr  
!rr  !
;rr! "
}ss 
}tt 	
public{{ 
async{{ 
Task{{ 
<{{ 
int{{ 
>{{ 
AddAsync{{ '
({{' (

Portafolio{{( 2
entity{{3 9
){{9 :
{|| 	
using}} 
(}} 
var}} 

connection}} !
=}}" #"
OracleConnectionHelper}}$ :
.}}: ;
GetConnection}}; H
(}}H I
)}}I J
)}}J K
{~~ 
await 

connection  
.  !
	OpenAsync! *
(* +
)+ ,
;, -
var
 

parameters
 
=
  
new
! $
{
 
p_FechaCreacion
 #
=
$ %
DateTime
& .
.
. /
UtcNow
/ 5
,
5 6!
p_FechaModificacion
 '
=
( )
DateTime
* 2
.
2 3
UtcNow
3 9
,
9 :
p_F_Posicion
  
=
! "
entity
# )
.
) *

F_Posicion
* 4
!
4 5
,
5 6
p_ListaDatos
  
=
! "
entity
# )
.
) *

ListaDatos
* 4
!
4 5
,
5 6 
p_NombrePortafolio
 &
=
' (
entity
) /
.
/ 0
NombrePortafolio
0 @
!
@ A
,
A B

p_No_Envio
 
=
  
$num
! "
,
" #
p_SubPortafolioId
 %
=
& '
entity
( .
.
. /
SubPortafolioId
/ >
}
 
;
 
var
 
query
 
=
 
@$"
 
$str
 +
{
+ ,!
_portfolioTableName
, ?
}
? @
$str@ 
" 
; ก
var
 
rowsAffected
  
=
! "
await
# (

connection
) 3
.
3 4
ExecuteAsync
4 @
(
@ A
query
A F
,
F G

parameters
H R
)
R S
;
S T
return
 
rowsAffected
 #
;
# $
}
 
}
 	
public
 
async
 
Task
 
<
 
bool
 
>
 
UpdateAsync
  +
(
+ ,

Portafolio
, 6
entity
7 =
)
= >
{
 	
using
 
(
 
var
 

connection
 !
=
" #$
OracleConnectionHelper
$ :
.
: ;
GetConnection
; H
(
H I
)
I J
)
J K
{
 
await
 

connection
  
.
  !
	OpenAsync
! *
(
* +
)
+ ,
;
, -
var
 

parameters
 
=
  
new
! $
{
 
p_Id
 
=
 
entity
 !
.
! "
IdPortafolio
" .
,
. /!
p_FechaModificacion
กก '
=
กก( )
DateTime
กก* 2
.
กก2 3
UtcNow
กก3 9
,
กก9 :
p_ListaDatos
ฃฃ  
=
ฃฃ! "
entity
ฃฃ# )
.
ฃฃ) *

ListaDatos
ฃฃ* 4
,
ฃฃ4 5

p_No_Envio
คค 
=
คค  
entity
คค! '
.
คค' (
No_Envio
คค( 0
+
คค1 2
$num
คค3 4
}
ฅฅ 
;
ฅฅ 
var
ฆฆ 
query
ฆฆ 
=
ฆฆ 
@$"
ฆฆ 
$str
ฆฆ &
{
ฆฆ& '!
_portfolioTableName
ฆฆ' :
}
ฆฆ: ;
$str
ฆช; 6
"
ชช6 7
;
ชช7 8
var
ซซ 
affectedRows
ซซ  
=
ซซ! "
await
ซซ# (

connection
ซซ) 3
.
ซซ3 4
ExecuteAsync
ซซ4 @
(
ซซ@ A
query
ซซA F
,
ซซF G

parameters
ซซH R
)
ซซR S
;
ซซS T
return
ฌฌ 
affectedRows
ฌฌ #
>
ฌฌ$ %
$num
ฌฌ& '
;
ฌฌ' (
}
ญญ 
}
ฎฎ 	
public
ตต 
async
ตต 
Task
ตต 
<
ตต 
bool
ตต 
>
ตต 
DeleteAsync
ตต  +
(
ตต+ ,
int
ตต, /
id
ตต0 2
)
ตต2 3
{
ถถ 	
using
ทท 
(
ทท 
var
ทท 

connection
ทท !
=
ทท" #$
OracleConnectionHelper
ทท$ :
.
ทท: ;
GetConnection
ทท; H
(
ททH I
)
ททI J
)
ททJ K
{
ธธ 
await
นน 

connection
นน  
.
นน  !
	OpenAsync
นน! *
(
นน* +
)
นน+ ,
;
นน, -
var
บบ 

parameters
บบ 
=
บบ  
new
บบ! $
{
บบ% &
p_Id
บบ' +
=
บบ, -
id
บบ. 0
}
บบ1 2
;
บบ2 3
var
ปป 
affectedRows
ปป  
=
ปป! "
await
ปป# (

connection
ปป) 3
.
ปป3 4
ExecuteAsync
ปป4 @
(
ปป@ A
$"
ปปA C
$str
ปปC O
{
ปปO P!
_portfolioTableName
ปปP c
}
ปปc d
$str
ปปd 
"ปป 
,ปป 

parametersปป 
)ปป 
;ปป 
return
ผผ 
affectedRows
ผผ #
>
ผผ$ %
$num
ผผ& '
;
ผผ' (
}
ฝฝ 
}
พพ 	
public
ฤฤ 
async
ฤฤ 
Task
ฤฤ 
<
ฤฤ 
IEnumerable
ฤฤ %
<
ฤฤ% &
SubPortafolios
ฤฤ& 4
>
ฤฤ4 5
>
ฤฤ5 6&
GetAllSubPortfoliosAsync
ฤฤ7 O
(
ฤฤO P
)
ฤฤP Q
{
ลล 	
using
ฦฦ 
(
ฦฦ 
OracleConnection
ฦฦ #

connection
ฦฦ$ .
=
ฦฦ/ 0$
OracleConnectionHelper
ฦฦ1 G
.
ฦฦG H
GetConnection
ฦฦH U
(
ฦฦU V
)
ฦฦV W
)
ฦฦW X
{
วว 
await
ศศ 

connection
ศศ  
.
ศศ  !
	OpenAsync
ศศ! *
(
ศศ* +
)
ศศ+ ,
;
ศศ, -
var
ษษ 
subPortfolios
ษษ !
=
ษษ" #
await
ษษ$ )

connection
ษษ* 4
.
ษษ4 5

QueryAsync
ษษ5 ?
<
ษษ? @
SubPortafolios
ษษ@ N
>
ษษN O
(
ษษO P
$"
ษษP R
$str
ษษR {
{
ษษ{ |%
_subPortfolioTableNameษษ| 
}ษษ 
"ษษ 
)ษษ 
;ษษ 
return
สส 
subPortfolios
สส $
;
สส$ %
}
หห 
}
ฬฬ 	
public
ำำ 
async
ำำ 
Task
ำำ 
<
ำำ 
List
ำำ 
<
ำำ 
string
ำำ %
>
ำำ% &
>
ำำ& ' 
SavePortfoliosList
ำำ( :
(
ำำ: ;
List
ำำ; ?
<
ำำ? @

Portafolio
ำำ@ J
>
ำำJ K
portafoliosList
ำำL [
)
ำำ[ \
{
ิิ 	
List
ีี 
<
ีี 
string
ีี 
>
ีี 
response
ีี !
=
ีี" #
new
ีี$ '
List
ีี( ,
<
ีี, -
string
ีี- 3
>
ีี3 4
(
ีี4 5
)
ีี5 6
;
ีี6 7
if
ืื 
(
ืื 
portafoliosList
ืื 
.
ืื  
Any
ืื  #
(
ืื# $
)
ืื$ %
)
ืื% &
{
ุุ 
using
ูู 
(
ูู 
var
ูู 

connection
ูู %
=
ูู& '$
OracleConnectionHelper
ูู( >
.
ูู> ?
GetConnection
ูู? L
(
ููL M
)
ููM N
)
ููN O
{
ฺฺ 
await
 

connection
 $
.
$ %
	OpenAsync
% .
(
. /
)
/ 0
;
0 1
using
 
(
 
var
 
transaction
 *
=
+ ,

connection
- 7
.
7 8
BeginTransaction
8 H
(
H I
)
I J
)
J K
{
 
try
 
{
฿฿ 
foreach
แแ #
(
แแ$ %
var
แแ% (
item
แแ) -
in
แแ. 0
portafoliosList
แแ1 @
)
แแ@ A
{
โโ 
List
ๅๅ  $
<
ๅๅ$ %
object
ๅๅ% +
>
ๅๅ+ ,
filters
ๅๅ- 4
=
ๅๅ5 6
new
ๅๅ7 :
List
ๅๅ; ?
<
ๅๅ? @
object
ๅๅ@ F
>
ๅๅF G
(
ๅๅG H
)
ๅๅH I
{
ๅๅJ K
new
ๆๆ$ '
{
ๆๆ( )

F_Posicion
็็( 2
=
็็3 4
item
็็5 9
.
็็9 :

F_Posicion
็็: D
}
่่$ %
,
่่% &
new
้้$ '
{
้้( )
SubPortafolioId
๊๊( 7
=
๊๊8 9
item
๊๊: >
.
๊๊> ?
SubPortafolioId
๊๊? N
}
๋๋$ %
}
์์  !
;
์์! "
var
๎๎  #
portafolios
๎๎$ /
=
๎๎0 1
await
๎๎2 7
this
๎๎8 <
.
๎๎< =
GetAllAsync
๎๎= H
(
๎๎H I
filters
๎๎I P
)
๎๎P Q
;
๎๎Q R
if
๏๏  "
(
๏๏# $
portafolios
๏๏$ /
.
๏๏/ 0
Any
๏๏0 3
(
๏๏3 4
)
๏๏4 5
&&
๏๏6 8
portafolios
๏๏9 D
.
๏๏D E
Count
๏๏E J
(
๏๏J K
)
๏๏K L
>
๏๏M N
$num
๏๏O P
)
๏๏P Q
{
๐๐  !
var
๑๑$ '
currentPortolio
๑๑( 7
=
๑๑8 9
portafolios
๑๑: E
.
๑๑E F
FirstOrDefault
๑๑F T
(
๑๑T U
)
๑๑U V
;
๑๑V W
currentPortolio
๒๒$ 3
!
๒๒3 4
.
๒๒4 5

ListaDatos
๒๒5 ?
=
๒๒@ A
item
๒๒B F
.
๒๒F G

ListaDatos
๒๒G Q
;
๒๒Q R
await
๓๓$ )
this
๓๓* .
.
๓๓. /
UpdateAsync
๓๓/ :
(
๓๓: ;
currentPortolio
๓๓; J
)
๓๓J K
;
๓๓K L
}
๔๔  !
else
๕๕  $
{
๖๖  !
await
๗๗$ )
this
๗๗* .
.
๗๗. /
AddAsync
๗๗/ 7
(
๗๗7 8
item
๗๗8 <
)
๗๗< =
;
๗๗= >
}
๘๘  !
}
๙๙ 
transaction
๚๚ '
.
๚๚' (
Commit
๚๚( .
(
๚๚. /
)
๚๚/ 0
;
๚๚0 1
}
๛๛ 
catch
 
(
 
	Exception
 (
ex
) +
)
+ ,
{
 
response
 $
.
$ %
Add
% (
(
( )
ex
) +
.
+ ,
Message
, 3
.
3 4
ToString
4 <
(
< =
)
= >
)
> ?
;
? @
transaction
 '
.
' (
Rollback
( 0
(
0 1
)
1 2
;
2 3
throw
 !
;
! "
}
 
}
 
}
 
}
 
return
 
response
 
;
 
}
 	
public
 
async
 
Task
 
<
 
bool
 
>
 
SaveFileBase64
  .
(
. /
string
/ 5
originalName
6 B
,
B C
string
D J
compoundName
K W
,
W X
byte
Y ]
[
] ^
]
^ _
stringBase64
` l
,
l m
string
n t
origen
u {
=
| }
$str~ 
) 
{
 	
using
 
(
 
var
 

connection
 !
=
" #$
OracleConnectionHelper
$ :
.
: ;
GetConnection
; H
(
H I
)
I J
)
J K
{
 
await
 

connection
  
.
  !
	OpenAsync
! *
(
* +
)
+ ,
;
, -
var
 

parameters
 
=
  
new
! $
{
 
p_Fecha
 
=
 
DateTime
 &
.
& '
UtcNow
' -
,
- .
p_NombreOrigen
 "
=
# $
originalName
% 1
,
1 2
p_NombreDestino
 #
=
$ %
compoundName
& 2
,
2 3
	p_Archivo
 
=
 
stringBase64
  ,
,
, -
p_Origen
 
=
 
$str
 '
}
 
;
 
var
 
query
 
=
 
@$"
 
$str
 +
{
+ ,!
_historialTableName
, ?
}
? @
$str
@ f
"
f g
;
g h
var
 
affectedRows
  
=
! "
await
# (

connection
) 3
.
3 4
ExecuteAsync
4 @
(
@ A
query
A F
,
F G

parameters
H R
)
R S
;
S T
return
 
affectedRows
 #
>
$ %
$num
& '
;
' (
}
 
}
กก 	
public
จจ 
async
จจ 
Task
จจ 
<
จจ 
ResponseDTO
จจ %
>
จจ% &
ReadOracleBLOB
จจ' 5
(
จจ5 6
string
จจ6 <
fileDate
จจ= E
)
จจE F
{
ฉฉ 	
ResponseDTO
ชช 
response
ชช  
=
ชช! "
new
ชช# &
ResponseDTO
ชช' 2
{
ชช3 4
	IsExitoso
ชช5 >
=
ชช? @
false
ชชA F
}
ชชG H
;
ชชH I
string
ฌฌ 
folderDownload
ฌฌ !
=
ฌฌ" #
@$"
ฌฌ$ '
{
ฌฌ' (
_configuration
ฌฌ( 6
.
ฌฌ6 7

GetSection
ฌฌ7 A
(
ฌฌA B
$str
ฌฌB P
)
ฌฌP Q
.
ฌฌQ R

GetSection
ฌฌR \
(
ฌฌ\ ]
$str
ฌฌ] q
)
ฌฌq r
.
ฌฌr s
Value
ฌฌs x
!
ฌฌx y
}
ฌฌy z
$str
ฌฌz {
"
ฌฌ{ |
;
ฌฌ| }
string
ญญ 
userRoot
ญญ 
=
ญญ 
Environment
ญญ )
.
ญญ) *$
GetEnvironmentVariable
ญญ* @
(
ญญ@ A
$str
ญญA N
)
ญญN O
!
ญญO P
+
ญญQ R
$str
ญญS W
;
ญญW X
var
ฎฎ 
date
ฎฎ 
=
ฎฎ 
DateTime
ฎฎ 
.
ฎฎ  
Now
ฎฎ  #
.
ฎฎ# $
ToString
ฎฎ$ ,
(
ฎฎ, -
$str
ฎฎ- 0
)
ฎฎ0 1
.
ฎฎ1 2
Replace
ฎฎ2 9
(
ฎฎ9 :
$str
ฎฎ: =
,
ฎฎ= >
$str
ฎฎ? B
)
ฎฎB C
;
ฎฎC D
string
ฏฏ 
fileName
ฏฏ 
=
ฏฏ 
$"
ฏฏ  
{
ฏฏ  !
userRoot
ฏฏ! )
}
ฏฏ) *
{
ฏฏ* +
folderDownload
ฏฏ+ 9
}
ฏฏ9 :
$str
ฏฏ: M
{
ฏฏM N
date
ฏฏN R
}
ฏฏR S
$str
ฏฏS W
"
ฏฏW X
;
ฏฏX Y
using
ฑฑ 
(
ฑฑ 
OracleConnection
ฑฑ #

connection
ฑฑ$ .
=
ฑฑ/ 0$
OracleConnectionHelper
ฑฑ1 G
.
ฑฑG H
GetConnection
ฑฑH U
(
ฑฑU V
)
ฑฑV W
)
ฑฑW X
{
ฒฒ 
await
ดด 

connection
ดด  
.
ดด  !
	OpenAsync
ดด! *
(
ดด* +
)
ดด+ ,
;
ดด, -
string
ตต 
strQuery
ตต 
=
ตต  !
@$"
ตต" %
$str
ตถ% %
{
ถถ% &!
_historialTableName
ถถ& 9
}
ถถ9 :
$str
ถท: ]
"
ทท] ^
;
ทท^ _
using
นน 
(
นน 
OracleCommand
นน $
cmd
นน% (
=
นน) *
new
นน+ .
OracleCommand
นน/ <
(
นน< =
strQuery
นน= E
,
นนE F

connection
นนG Q
)
นนQ R
)
นนR S
{
บบ 
cmd
ปป 
.
ปป 

Parameters
ปป "
.
ปป" #
Add
ปป# &
(
ปป& '
$str
ปป' 0
,
ปป0 1
OracleDbType
ปป2 >
.
ปป> ?
Varchar2
ปป? G
)
ปปG H
.
ปปH I
Value
ปปI N
=
ปปO P
fileDate
ปปQ Y
;
ปปY Z
using
ฝฝ 
(
ฝฝ 
OracleDataReader
ฝฝ +
reader
ฝฝ, 2
=
ฝฝ3 4
cmd
ฝฝ5 8
.
ฝฝ8 9
ExecuteReader
ฝฝ9 F
(
ฝฝF G
)
ฝฝG H
)
ฝฝH I
{
พพ 
if
ฟฟ 
(
ฟฟ 
reader
ฟฟ "
.
ฟฟ" #
Read
ฟฟ# '
(
ฟฟ' (
)
ฟฟ( )
)
ฟฟ) *
{
ภภ 

OracleBlob
ยย &
blob
ยย' +
=
ยย, -
reader
ยย. 4
.
ยย4 5
GetOracleBlob
ยย5 B
(
ยยB C
$num
ยยC D
)
ยยD E
;
ยยE F
if
ฤฤ 
(
ฤฤ  
!
ฤฤ  !
reader
ฤฤ! '
.
ฤฤ' (
IsDBNull
ฤฤ( 0
(
ฤฤ0 1
$num
ฤฤ1 2
)
ฤฤ2 3
)
ฤฤ3 4
{
ลล 
using
ฦฦ  %
(
ฦฦ& '

FileStream
ฦฦ' 1
fs
ฦฦ2 4
=
ฦฦ5 6
new
ฦฦ7 :

FileStream
ฦฦ; E
(
ฦฦE F
fileName
ฦฦF N
,
ฦฦN O
FileMode
ฦฦP X
.
ฦฦX Y
Create
ฦฦY _
)
ฦฦ_ `
)
ฦฦ` a
{
วว  !
fs
ศศ$ &
.
ศศ& '
Write
ศศ' ,
(
ศศ, -
blob
ศศ- 1
.
ศศ1 2
Value
ศศ2 7
,
ศศ7 8
$num
ศศ9 :
,
ศศ: ;
(
ศศ< =
int
ศศ= @
)
ศศ@ A
blob
ศศA E
.
ศศE F
Length
ศศF L
)
ศศL M
;
ศศM N
response
ษษ$ ,
.
ษษ, -
	IsExitoso
ษษ- 6
=
ษษ7 8
true
ษษ9 =
;
ษษ= >
response
สส$ ,
.
สส, -
Mensaje
สส- 4
=
สส5 6
$"
สส7 9
$str
สส9 Y
{
สสY Z
fileName
สสZ b
}
สสb c
"
สสc d
;
สสd e
response
หห$ ,
.
หห, -

StatusCode
หห- 7
=
หห8 9
HttpStatusCode
หห: H
.
หหH I
OK
หหI K
;
หหK L
}
ฬฬ  !
}
ออ 
else
ฮฮ  
{
ฯฯ 
response
ัั  (
.
ัั( )
	IsExitoso
ัั) 2
=
ัั3 4
false
ัั5 :
;
ัั: ;
response
าา  (
.
าา( )
Mensaje
าา) 0
=
าา1 2
$"
าา3 5
$str
าา5 I
{
าาI J
fileDate
าาJ R
}
าาR S
$str
าาS g
"
าาg h
;
าาh i
response
ำำ  (
.
ำำ( )

StatusCode
ำำ) 3
=
ำำ4 5
HttpStatusCode
ำำ6 D
.
ำำD E
NotFound
ำำE M
;
ำำM N
}
ิิ 
}
ีี 
else
ึึ 
{
ืื 
response
ุุ $
.
ุุ$ %
	IsExitoso
ุุ% .
=
ุุ/ 0
false
ุุ1 6
;
ุุ6 7
response
ูู $
.
ูู$ %
Mensaje
ูู% ,
=
ูู- .
$"
ูู/ 1
$str
ูู1 _
{
ูู_ `
fileDate
ูู` h
}
ููh i
"
ููi j
;
ููj k
response
ฺฺ $
.
ฺฺ$ %

StatusCode
ฺฺ% /
=
ฺฺ0 1
HttpStatusCode
ฺฺ2 @
.
ฺฺ@ A

BadRequest
ฺฺA K
;
ฺฺK L
}
 
}
 
}
 
}
 
return
เเ 
response
เเ 
;
เเ 
}
แแ 	
private
๊๊ 
List
๊๊ 
<
๊๊ 
OracleParameter
๊๊ $
>
๊๊$ %!
GetOracleParameters
๊๊& 9
(
๊๊9 :
IEnumerable
๊๊: E
<
๊๊E F
object
๊๊F L
>
๊๊L M"
anonymousObjectsList
๊๊N b
)
๊๊b c
{
๋๋ 	
List
์์ 
<
์์ 
OracleParameter
์์  
>
์์  !
parameterList
์์" /
=
์์0 1
new
์์2 5
List
์์6 :
<
์์: ;
OracleParameter
์์; J
>
์์J K
(
์์K L
)
์์L M
;
์์M N
foreach
๎๎ 
(
๎๎ 
var
๎๎ 
anonymousObject
๎๎ (
in
๎๎) +"
anonymousObjectsList
๎๎, @
)
๎๎@ A
{
๏๏ 
var
๑๑ 

properties
๑๑ 
=
๑๑  
anonymousObject
๑๑! 0
.
๑๑0 1
GetType
๑๑1 8
(
๑๑8 9
)
๑๑9 :
.
๑๑: ;
GetProperties
๑๑; H
(
๑๑H I
)
๑๑I J
;
๑๑J K
foreach
๓๓ 
(
๓๓ 
var
๓๓ 
	propiedad
๓๓ &
in
๓๓' )

properties
๓๓* 4
)
๓๓4 5
{
๔๔ 
string
๖๖ 
nombreParametro
๖๖ *
=
๖๖+ ,
$str
๖๖- 2
+
๖๖3 4
	propiedad
๖๖5 >
.
๖๖> ?
Name
๖๖? C
;
๖๖C D
object
๗๗ 
valorParametro
๗๗ )
=
๗๗* +
	propiedad
๗๗, 5
.
๗๗5 6
GetValue
๗๗6 >
(
๗๗> ?
anonymousObject
๗๗? N
)
๗๗N O
!
๗๗O P
;
๗๗P Q
OracleParameter
๚๚ #
	parametro
๚๚$ -
=
๚๚. /
new
๚๚0 3
OracleParameter
๚๚4 C
(
๚๚C D
nombreParametro
๚๚D S
,
๚๚S T
valorParametro
๚๚U c
??
๚๚d f
DBNull
๚๚g m
.
๚๚m n
Value
๚๚n s
)
๚๚s t
;
๚๚t u
parameterList
๛๛ !
.
๛๛! "
Add
๛๛" %
(
๛๛% &
	parametro
๛๛& /
)
๛๛/ 0
;
๛๛0 1
}
 
}
 
return
 
parameterList
  
;
  !
}
 	
private
 

Dictionary
 
<
 
string
 !
,
! "
object
# )
>
) *#
GetAnonymusParameters
+ @
(
@ A
IEnumerable
A L
<
L M
object
M S
>
S T"
anonymousObjectsList
U i
)
i j
{
 	
var
 
parameterList
 
=
 
new
  #

Dictionary
$ .
<
. /
string
/ 5
,
5 6
object
7 =
>
= >
(
> ?
)
? @
{
A B
}
C D
;
D E
foreach
 
(
 
var
 
anonymousObject
 (
in
) +"
anonymousObjectsList
, @
)
@ A
{
 
var
 

properties
 
=
  
anonymousObject
! 0
.
0 1
GetType
1 8
(
8 9
)
9 :
.
: ;
GetProperties
; H
(
H I
)
I J
;
J K
foreach
 
(
 
var
 
	propiedad
 &
in
' )

properties
* 4
)
4 5
{
 
string
 
nombreParametro
 *
=
+ ,
$str
- 1
+
2 3
	propiedad
4 =
.
= >
Name
> B
;
B C
object
 
valorParametro
 )
=
* +
	propiedad
, 5
.
5 6
GetValue
6 >
(
> ?
anonymousObject
? N
)
N O
!
O P
;
P Q
parameterList
 !
.
! "
Add
" %
(
% &
nombreParametro
& 5
,
5 6
valorParametro
7 E
!
E F
)
F G
;
G H
}
 
}
 
return
 
parameterList
  
;
  !
}
 	
}
 
} ;
ลD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Infrastructure.Oracle\Repositories\AuthorizationRepository.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Infrastructure (
.( )
Oracle) /
./ 0
Repositories0 <
{		 
public 

class #
AuthorizationRepository (
:) *$
IAuthorizationRepository+ C
{ 
private 
readonly 
IConfiguration '
_configuration( 6
;6 7
private 
readonly 
string 
?  
_tokensTableName! 1
=2 3
string4 :
.: ;
Empty; @
;@ A
public #
AuthorizationRepository &
(& '
IConfiguration' 5
configuration6 C
)C D
{ 	
_configuration 
= 
configuration *
;* +
_tokensTableName 
= 
_configuration -
.- .

GetSection. 8
(8 9
$str9 I
)I J
.J K

GetSectionK U
(U V
$strV `
)` a
.a b
Valueb g
!g h
;h i
} 	
public 
async 
Task 
< 
int 
> 
AddAsync '
(' (
Token( -
entity. 4
)4 5
{   	
using!! 
(!! 
var!! 

connection!! !
=!!" #"
OracleConnectionHelper!!$ :
.!!: ;
GetConnection!!; H
(!!H I
)!!I J
)!!J K
{"" 
await## 

connection##  
.##  !
	OpenAsync##! *
(##* +
)##+ ,
;##, -
var$$ 

parameters$$ 
=$$  
new$$! $
{%% 
p_AccessToken&& !
=&&" #
entity&&$ *
.&&* +
AccessToken&&+ 6
,&&6 7
p_ExpirationDate'' $
=''% &
entity''' -
.''- .
ExpirationDate''. <
,''< =
p_RefreshToken)) "
=))# $
entity))% +
.))+ ,
RefreshToken)), 8
,))8 9
p_UsuarioId++ 
=++  !
entity++" (
.++( )
	UsuarioId++) 2
,++2 3
},, 
;,, 
var-- 
query-- 
=-- 
@$"-- 
$str-- +
{--+ ,
_tokensTableName--, <
}--< =
$str-.= e
"..e f
;..f g
var// 
rowsAffected//  
=//! "
await//# (

connection//) 3
.//3 4
ExecuteAsync//4 @
(//@ A
query//A F
,//F G

parameters//H R
)//R S
;//S T
return00 
rowsAffected00 #
;00# $
}11 
}22 	
public44 
Task44 
<44 
bool44 
>44 
DeleteAsync44 %
(44% &
int44& )
id44* ,
)44, -
{55 	
throw66 
new66 #
NotImplementedException66 -
(66- .
)66. /
;66/ 0
}77 	
public== 
async== 
Task== 
<== 
IEnumerable== %
<==% &
Token==& +
>==+ ,
>==, -
GetAllAsync==. 9
(==9 :
)==: ;
{>> 	
using?? 
(?? 
var?? 

connection?? !
=??" #"
OracleConnectionHelper??$ :
.??: ;
GetConnection??; H
(??H I
)??I J
)??J K
{@@ 
awaitAA 

connectionAA  
.AA  !
	OpenAsyncAA! *
(AA* +
)AA+ ,
;AA, -
stringBB 
strQueryBB 
=BB  !
@$"BB" %
$strBC% *
{CC* +
_tokensTableNameCC+ ;
}CC; <
"CC< =
;CC= >
returnDD 
awaitDD 

connectionDD '
.DD' (

QueryAsyncDD( 2
<DD2 3
TokenDD3 8
>DD8 9
(DD9 :
strQueryDD: B
)DDB C
;DDC D
}EE 
}FF 	
publicMM 
asyncMM 
TaskMM 
<MM 
TokenMM 
>MM  
GetByIdAsyncMM! -
(MM- .
intMM. 1
tokenIdMM2 9
)MM9 :
{NN 	
usingOO 
(OO 
OracleConnectionOO #

connectionOO$ .
=OO/ 0"
OracleConnectionHelperOO1 G
.OOG H
GetConnectionOOH U
(OOU V
)OOV W
)OOW X
{PP 
awaitQQ 

connectionQQ  
.QQ  !
	OpenAsyncQQ! *
(QQ* +
)QQ+ ,
;QQ, -
varRR 

parametersRR 
=RR  
newRR! $
{RR% &
p_IdRR' +
=RR, -
tokenIdRR. 5
}RR6 7
;RR7 8
stringSS 
strQuerySS 
=SS  !
@$"SS" %
$strST% *
{TT* +
_tokensTableNameTT+ ;
}TT; <
$strTT< R
"TTR S
;TTS T
varUU 
userUU 
=UU 
awaitUU  

connectionUU! +
.UU+ ,$
QueryFirstOrDefaultAsyncUU, D
<UUD E
TokenUUE J
>UUJ K
(UUK L
strQueryUUL T
,UUT U

parametersUUV `
)UU` a
;UUa b
returnWW 
userWW 
!WW 
;WW 
}XX 
}YY 	
public`` 
async`` 
Task`` 
<`` 
bool`` 
>`` 
UpdateAsync``  +
(``+ ,
Token``, 1
entity``2 8
)``8 9
{aa 	
usingbb 
(bb 
varbb 

connectionbb !
=bb" #"
OracleConnectionHelperbb$ :
.bb: ;
GetConnectionbb; H
(bbH I
)bbI J
)bbJ K
{cc 
awaitdd 

connectiondd  
.dd  !
	OpenAsyncdd! *
(dd* +
)dd+ ,
;dd, -
varee 

parametersee 
=ee  
newee! $
{ff 
p_AccessTokengg !
=gg" #
entitygg$ *
.gg* +
AccessTokengg+ 6
,gg6 7
p_ExpirationDatehh $
=hh% &
entityhh' -
.hh- .
ExpirationDatehh. <
,hh< =
p_RefreshTokenii "
=ii# $
entityii% +
.ii+ ,
RefreshTokenii, 8
,ii8 9
	p_TokenIdjj 
=jj 
entityjj  &
.jj& '
TokenIdjj' .
,jj. /
p_UsuarioIdkk 
=kk  !
entitykk" (
.kk( )
	UsuarioIdkk) 2
}ll 
;ll 
varmm 
querymm 
=mm 
@$"mm 
$strmm &
{mm& '
_tokensTableNamemm' 7
}mm7 8
$strmr8 :
"rr: ;
;rr; <
varss 
affectedRowsss  
=ss! "
awaitss# (

connectionss) 3
.ss3 4
ExecuteAsyncss4 @
(ss@ A
queryssA F
,ssF G

parametersssH R
)ssR S
;ssS T
returntt 
affectedRowstt #
>tt$ %
$numtt& '
;tt' (
}uu 
}vv 	
}ww 
}yy 