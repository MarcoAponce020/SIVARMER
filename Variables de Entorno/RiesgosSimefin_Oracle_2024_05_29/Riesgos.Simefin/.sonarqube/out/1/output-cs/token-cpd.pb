๘
ฐD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\UseCases\PortfolioUseCase.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &
UseCases& .
{ 
public 

class 
PortfolioUseCase !
:" #
IPortfolioUseCase$ 5
{ 
private 
readonly  
IPortfolioRepository - 
_portfolioRepository. B
;B C
private 
readonly 
IConfiguration '
_configuration( 6
;6 7
private 
const 
int 
rowDate !
=" #
$num$ %
;% &
private 
readonly 
string #
uploadServerFileUrlPath  7
;7 8
private 
readonly 
string $
uploadServerFolderSource  8
;8 9
private 
readonly 
string %
downloadServerFileUrlPath  9
;9 :
private 
readonly 
string +
downloadServerFolderDestination  ?
;? @
private   
readonly   
string   
fileName    (
;  ( )
private!! 
readonly!! 
string!! 
contentType!!  +
;!!+ ,
private"" 
readonly"" 
string"" 
[""  
]""  !

originList""" ,
=""- .
[""/ 0
$str""0 :
,"": ;
$str""< D
]""D E
;""E F
private## 
string## 
procedencia## "
=### $
string##% +
.##+ ,
Empty##, 1
;##1 2
public&& 
PortfolioUseCase&& 
(&&   
IPortfolioRepository&&  4
portfolioRepository&&5 H
,&&H I
IConfiguration&&J X
configuration&&Y f
)&&f g
{'' 	 
_portfolioRepository((  
=((! "
portfolioRepository((# 6
;((6 7
_configuration)) 
=)) 
configuration)) *
;))* +#
uploadServerFileUrlPath++ #
=++$ %
_configuration++& 4
.++4 5

GetSection++5 ?
(++? @
$str++@ L
)++L M
.++M N

GetSection++N X
(++X Y
$str++Y l
)++l m
.++m n
Value++n s
!++s t
;++t u$
uploadServerFolderSource,, $
=,,% &
_configuration,,' 5
.,,5 6

GetSection,,6 @
(,,@ A
$str,,A M
),,M N
.,,N O

GetSection,,O Y
(,,Y Z
$str,,Z n
),,n o
.,,o p
Value,,p u
!,,u v
;,,v w
fileName-- 
=-- 
_configuration-- %
.--% &

GetSection--& 0
(--0 1
$str--1 =
)--= >
.--> ?

GetSection--? I
(--I J
$str--J T
)--T U
.--U V
Value--V [
!--[ \
;--\ ]
contentType.. 
=.. 
_configuration.. (
...( )

GetSection..) 3
(..3 4
$str..4 @
)..@ A
...A B

GetSection..B L
(..L M
$str..M ^
)..^ _
..._ `
Value..` e
!..e f
;..f g%
downloadServerFileUrlPath00 %
=00& '
_configuration00( 6
.006 7

GetSection007 A
(00A B
$str00B P
)00P Q
.00Q R

GetSection00R \
(00\ ]
$str00] p
)00p q
.00q r
Value00r w
!00w x
;00x y+
downloadServerFolderDestination11 +
=11, -
_configuration11. <
.11< =

GetSection11= G
(11G H
$str11H V
)11V W
.11W X

GetSection11X b
(11b c
$str11c |
)11| }
.11} ~
Value	11~ 
!
11 
;
11 
}22 	
public99 
async99 
Task99 
<99 
ResponseDTO99 %
>99% &
CreatePortfolio99' 6
(996 7
PortafolioCreateDTO997 J
request99K R
)99R S
{:: 	
ResponseDTO;; 
response;;  
=;;! "
new;;# &
ResponseDTO;;' 2
(;;2 3
);;3 4
;;;4 5
try<< 
{== 

Portafolio?? 
model??  
=??! "
new??# &

Portafolio??' 1
{@@ 

F_PosicionAA 
=AA  
requestAA! (
.AA( )

F_PosicionAA) 3
,AA3 4

ListaDatosBB 
=BB  
requestBB! (
.BB( )

ListaDatosBB) 3
,BB3 4
NombrePortafolioCC $
=CC% &
requestCC' .
!CC. /
.CC/ 0
NombrePortafolioCC0 @
,CC@ A
SubPortafolioIdDD #
=DD$ %
requestDD& -
!DD- .
.DD. /
SubPortafolioIdDD/ >
}EE 
;EE 
responseGG 
.GG 
	ResultadoGG "
=GG# $
awaitGG% * 
_portfolioRepositoryGG+ ?
.GG? @
AddAsyncGG@ H
(GGH I
modelGGI N
)GGN O
;GGO P
responseHH 
.HH 
	IsExitosoHH "
=HH# $
trueHH% )
;HH) *
responseII 
.II 
MensajeII  
=II! "
$strII# ?
;II? @
responseJJ 
.JJ 

StatusCodeJJ #
=JJ$ %
HttpStatusCodeJJ& 4
.JJ4 5
OKJJ5 7
;JJ7 8
}KK 
catchLL 
(LL 
	ExceptionLL 
exLL 
)LL  
{MM 
responseNN 
.NN 
	IsExitosoNN "
=NN# $
falseNN% *
;NN* +
responseOO 
.OO 
ErrorMessagesOO &
.OO& '
AddOO' *
(OO* +"
ExceptionMessageHelperOO+ A
.OOA B
GetExceptionMessageOOB U
(OOU V
exOOV X
)OOX Y
)OOY Z
;OOZ [
responsePP 
.PP 

StatusCodePP #
=PP$ %
HttpStatusCodePP& 4
.PP4 5

BadRequestPP5 ?
;PP? @
}QQ 
returnSS 
responseSS 
;SS 
}TT 	
public[[ 
async[[ 
Task[[ 
<[[ 
ResponseDTO[[ %
>[[% &
DeletePortfolio[[' 6
([[6 7
int[[7 :
id[[; =
)[[= >
{\\ 	
ResponseDTO]] 
response]]  
=]]! "
new]]# &
ResponseDTO]]' 2
(]]2 3
)]]3 4
;]]4 5
if__ 
(__ 
id__ 
==__ 
$num__ 
)__ 
{`` 
responseaa 
.aa 
	IsExitosoaa "
=aa# $
falseaa% *
;aa* +
responsebb 
.bb 

StatusCodebb #
=bb$ %
HttpStatusCodebb& 4
.bb4 5

BadRequestbb5 ?
;bb? @
returncc 
responsecc 
;cc  
}dd 
tryff 
{gg 
varhh 
deletePortfoliohh #
=hh$ %
awaithh& +
thishh, 0
.hh0 1
GetPortfolioByIdhh1 A
(hhA B
idhhB D
)hhD E
;hhE F
ifii 
(ii 
deletePortfolioii #
==ii$ &
nullii' +
||ii, .
(ii/ 0
deletePortfolioii0 ?
!=ii@ B
nulliiC G
&&iiH J
!iiK L
deletePortfolioiiL [
.ii[ \
	IsExitosoii\ e
)iie f
)iif g
{jj 
returnkk 
deletePortfoliokk *
!kk* +
;kk+ ,
}ll 
responsenn 
.nn 
	Resultadonn "
=nn# $
awaitnn% * 
_portfolioRepositorynn+ ?
.nn? @
DeleteAsyncnn@ K
(nnK L
idnnL N
)nnN O
;nnO P
responseoo 
.oo 
	IsExitosooo "
=oo# $
trueoo% )
;oo) *
responsepp 
.pp 
Mensajepp  
=pp! "
$strpp# B
;ppB C
responseqq 
.qq 

StatusCodeqq #
=qq$ %
Systemqq& ,
.qq, -
Netqq- 0
.qq0 1
HttpStatusCodeqq1 ?
.qq? @
OKqq@ B
;qqB C
}rr 
catchss 
(ss 
	Exceptionss 
exss 
)ss  
{tt 
responseuu 
.uu 
	IsExitosouu "
=uu# $
falseuu% *
;uu* +
responsevv 
.vv 
ErrorMessagesvv &
.vv& '
Addvv' *
(vv* +"
ExceptionMessageHelpervv+ A
.vvA B
GetExceptionMessagevvB U
(vvU V
exvvV X
)vvX Y
)vvY Z
;vvZ [
responseww 
.ww 

StatusCodeww #
=ww$ %
HttpStatusCodeww& 4
.ww4 5

BadRequestww5 ?
;ww? @
}xx 
returnzz 
responsezz 
;zz 
}{{ 	
public
 
async
 
Task
 
<
 
ResponseDTO
 %
>
% &
GetAllPortfolio
' 6
(
6 7
)
7 8
{
 	
ResponseDTO
 
response
  
=
! "
new
# &
ResponseDTO
' 2
(
2 3
)
3 4
;
4 5
try
 
{
 
response
 
.
 
	Resultado
 "
=
# $
await
% *"
_portfolioRepository
+ ?
.
? @
GetAllAsync
@ K
(
K L
)
L M
;
M N
response
 
.
 
	IsExitoso
 "
=
# $
true
% )
;
) *
}
 
catch
 
(
 
	Exception
 
ex
 
)
  
{
 
response
 
.
 
	IsExitoso
 "
=
# $
false
% *
;
* +
response
 
.
 
ErrorMessages
 &
.
& '
Add
' *
(
* +$
ExceptionMessageHelper
+ A
.
A B!
GetExceptionMessage
B U
(
U V
ex
V X
)
X Y
)
Y Z
;
Z [
}
 
return
 
response
 
;
 
}
 	
public
 
async
 
Task
 
<
 
ResponseDTO
 %
>
% & 
GetPortfolioByDate
' 9
(
9 :
string
: @
positionDate
A M
)
M N
{
 	
ResponseDTO
 
response
  
=
! "
new
# &
ResponseDTO
' 2
(
2 3
)
3 4
;
4 5
try
 
{
 
List
 
<
 
object
 
>
 
filters
 $
=
% &
new
' *
List
+ /
<
/ 0
object
0 6
>
6 7
(
7 8
)
8 9
{
: ;
new
 
{
 

F_Posicion
กก "
=
กก# $
positionDate
กก% 1
}
ขข 
}
ฃฃ 
;
ฃฃ 
IEnumerable
คค 
<
คค 

Portafolio
คค &
>
คค& '
portfolioList
คค( 5
=
คค6 7
await
คค8 ="
_portfolioRepository
คค> R
.
คคR S
GetAllAsync
คคS ^
(
คค^ _
filters
คค_ f
)
คคf g
;
คคg h
if
ฅฅ 
(
ฅฅ 
!
ฅฅ 
portfolioList
ฅฅ "
!
ฅฅ" #
.
ฅฅ# $
Any
ฅฅ$ '
(
ฅฅ' (
)
ฅฅ( )
)
ฅฅ) *
{
ฆฆ 
response
งง 
.
งง 
	IsExitoso
งง &
=
งง' (
false
งง) .
;
งง. /
response
จจ 
.
จจ 
ErrorMessages
จจ *
.
จจ* +
Add
จจ+ .
(
จจ. /
$str
จจ/ V
)
จจV W
;
จจW X
response
ฉฉ 
.
ฉฉ 

StatusCode
ฉฉ '
=
ฉฉ( )
HttpStatusCode
ฉฉ* 8
.
ฉฉ8 9
NotFound
ฉฉ9 A
;
ฉฉA B
return
ชช 
response
ชช #
;
ชช# $
}
ซซ 
response
ฌฌ 
.
ฌฌ 
	Resultado
ฌฌ "
=
ฌฌ# $
portfolioList
ฌฌ% 2
;
ฌฌ2 3
response
ญญ 
.
ญญ 
	IsExitoso
ญญ "
=
ญญ# $
response
ญญ% -
.
ญญ- .
	Resultado
ญญ. 7
!=
ญญ8 :
null
ญญ; ?
;
ญญ? @
response
ฎฎ 
.
ฎฎ 

StatusCode
ฎฎ #
=
ฎฎ$ %
HttpStatusCode
ฎฎ& 4
.
ฎฎ4 5
OK
ฎฎ5 7
;
ฎฎ7 8
}
ฏฏ 
catch
ฐฐ 
(
ฐฐ 
	Exception
ฐฐ 
ex
ฐฐ 
)
ฐฐ  
{
ฑฑ 
response
ฒฒ 
.
ฒฒ 
	IsExitoso
ฒฒ "
=
ฒฒ# $
false
ฒฒ% *
;
ฒฒ* +
response
ณณ 
.
ณณ 
ErrorMessages
ณณ &
.
ณณ& '
Add
ณณ' *
(
ณณ* +$
ExceptionMessageHelper
ณณ+ A
.
ณณA B!
GetExceptionMessage
ณณB U
(
ณณU V
ex
ณณV X
)
ณณX Y
)
ณณY Z
;
ณณZ [
}
ดด 
return
ถถ 
response
ถถ 
;
ถถ 
}
ทท 	
public
พพ 
async
พพ 
Task
พพ 
<
พพ 
ResponseDTO
พพ %
>
พพ% &
GetPortfolioById
พพ' 7
(
พพ7 8
int
พพ8 ;
id
พพ< >
)
พพ> ?
{
ฟฟ 	
ResponseDTO
ภภ 
response
ภภ  
=
ภภ! "
new
ภภ# &
ResponseDTO
ภภ' 2
(
ภภ2 3
)
ภภ3 4
;
ภภ4 5
try
ยย 
{
รร 
response
ฤฤ 
.
ฤฤ 
	Resultado
ฤฤ "
=
ฤฤ# $
await
ฤฤ% *"
_portfolioRepository
ฤฤ+ ?
.
ฤฤ? @
GetByIdAsync
ฤฤ@ L
(
ฤฤL M
id
ฤฤM O
)
ฤฤO P
;
ฤฤP Q
response
ลล 
.
ลล 
	IsExitoso
ลล "
=
ลล# $
response
ลล% -
.
ลล- .
	Resultado
ลล. 7
!=
ลล8 :
null
ลล; ?
;
ลล? @
response
ฦฦ 
.
ฦฦ 

StatusCode
ฦฦ #
=
ฦฦ$ %
HttpStatusCode
ฦฦ& 4
.
ฦฦ4 5
OK
ฦฦ5 7
;
ฦฦ7 8
if
วว 
(
วว 
response
วว 
.
วว 
	Resultado
วว &
==
วว' )
null
วว* .
)
วว. /
{
ศศ 
response
ษษ 
.
ษษ 
Mensaje
ษษ $
=
ษษ% &
$str
ษษ' @
;
ษษ@ A
response
สส 
.
สส 

StatusCode
สส '
=
สส( )
HttpStatusCode
สส* 8
.
สส8 9
NotFound
สส9 A
;
สสA B
return
หห 
response
หห #
;
หห# $
}
ฬฬ 
}
ออ 
catch
ฮฮ 
(
ฮฮ 
	Exception
ฮฮ 
ex
ฮฮ 
)
ฮฮ  
{
ฯฯ 
response
ะะ 
.
ะะ 
	IsExitoso
ะะ "
=
ะะ# $
false
ะะ% *
;
ะะ* +
response
ัั 
.
ัั 
ErrorMessages
ัั &
.
ัั& '
Add
ัั' *
(
ัั* +$
ExceptionMessageHelper
ัั+ A
.
ััA B!
GetExceptionMessage
ััB U
(
ััU V
ex
ััV X
)
ััX Y
)
ััY Z
;
ััZ [
}
าา 
return
ิิ 
response
ิิ 
;
ิิ 
}
ีี 	
public
 
async
 
Task
 
<
 
ResponseDTO
 %
>
% &
UpdatePortfolio
' 6
(
6 7
int
7 :
portafolioId
; G
,
G H!
PortafolioUpdateDTO
I \
request
] d
)
d e
{
 	
ResponseDTO
฿฿ 
response
฿฿  
=
฿฿! "
new
฿฿# &
ResponseDTO
฿฿' 2
(
฿฿2 3
)
฿฿3 4
;
฿฿4 5
if
แแ 
(
แแ 
portafolioId
แแ 
==
แแ 
$num
แแ  !
||
แแ" $
(
แแ% &
request
แแ& -
==
แแ. 0
null
แแ1 5
||
แแ6 8
string
แแ9 ?
.
แแ? @
IsNullOrEmpty
แแ@ M
(
แแM N
request
แแN U
.
แแU V

ListaDatos
แแV `
)
แแ` a
)
แแa b
)
แแb c
{
โโ 
response
ใใ 
.
ใใ 
	IsExitoso
ใใ "
=
ใใ# $
false
ใใ% *
;
ใใ* +
response
ไไ 
.
ไไ 

StatusCode
ไไ #
=
ไไ$ %
HttpStatusCode
ไไ& 4
.
ไไ4 5

BadRequest
ไไ5 ?
;
ไไ? @
return
ๅๅ 
response
ๅๅ 
;
ๅๅ  
}
ๆๆ 
try
่่ 
{
้้ 
var
๊๊ 
updatePortfolio
๊๊ #
=
๊๊$ %
await
๊๊& +"
_portfolioRepository
๊๊, @
.
๊๊@ A
GetByIdAsync
๊๊A M
(
๊๊M N
portafolioId
๊๊N Z
)
๊๊Z [
;
๊๊[ \
if
๋๋ 
(
๋๋ 
updatePortfolio
๋๋ #
==
๋๋$ &
null
๋๋' +
||
๋๋, .
updatePortfolio
๋๋/ >
.
๋๋> ?
IdPortafolio
๋๋? K
<=
๋๋L N
$num
๋๋O P
)
๋๋P Q
{
์์ 
response
ํํ 
.
ํํ 
	IsExitoso
ํํ &
=
ํํ' (
false
ํํ) .
;
ํํ. /
response
๎๎ 
.
๎๎ 
Mensaje
๎๎ $
=
๎๎% &
$str
๎๎' @
;
๎๎@ A
response
๏๏ 
.
๏๏ 

StatusCode
๏๏ '
=
๏๏( )
HttpStatusCode
๏๏* 8
.
๏๏8 9
NotFound
๏๏9 A
;
๏๏A B
return
๐๐ 
response
๐๐ #
;
๐๐# $
}
๑๑ 

Portafolio
๔๔ 
model
๔๔  
=
๔๔! "
new
๔๔# &

Portafolio
๔๔' 1
{
๕๕ 
IdPortafolio
๖๖  
=
๖๖! "
updatePortfolio
๖๖# 2
.
๖๖2 3
IdPortafolio
๖๖3 ?
,
๖๖? @

ListaDatos
๗๗ 
=
๗๗  
request
๗๗! (
.
๗๗( )

ListaDatos
๗๗) 3
,
๗๗3 4
No_Envio
๘๘ 
=
๘๘ 
updatePortfolio
๘๘ .
.
๘๘. /
No_Envio
๘๘/ 7
,
๘๘7 8
}
๙๙ 
;
๙๙ 
response
๛๛ 
.
๛๛ 
	Resultado
๛๛ "
=
๛๛# $
await
๛๛% *"
_portfolioRepository
๛๛+ ?
.
๛๛? @
UpdateAsync
๛๛@ K
(
๛๛K L
model
๛๛L Q
)
๛๛Q R
;
๛๛R S
response
 
.
 
	IsExitoso
 "
=
# $
true
% )
;
) *
response
 
.
 
Mensaje
  
=
! "
$str
# D
;
D E
response
 
.
 

StatusCode
 #
=
$ %
HttpStatusCode
& 4
.
4 5
OK
5 7
;
7 8
}
 
catch
 
(
 
	Exception
 
ex
 
)
  
{
 
response
 
.
 
	IsExitoso
 "
=
# $
false
% *
;
* +
response
 
.
 
ErrorMessages
 &
.
& '
Add
' *
(
* +$
ExceptionMessageHelper
+ A
.
A B!
GetExceptionMessage
B U
(
U V
ex
V X
)
X Y
)
Y Z
;
Z [
response
 
.
 

StatusCode
 #
=
$ %
HttpStatusCode
& 4
.
4 5

BadRequest
5 ?
;
? @
}
 
return
 
response
 
;
 
}
 	
public
 
async
 
Task
 
<
 
ResponseDTO
 %
>
% &
	ExcelLoad
' 0
(
0 1
	IFormFile
1 :
file
; ?
)
? @
{
 	
var
 
isValidFile
 
=
 
this
 "
.
" #
ValidateFileExist
# 4
(
4 5
ref
5 8
file
9 =
)
= >
;
> ?
if
 
(
 
!
 
isValidFile
 
.
 
	IsExitoso
 &
)
& '
{
 
return
 
isValidFile
 "
;
" #
}
 
ResponseDTO
 
response
  
=
! "
new
# &
ResponseDTO
' 2
(
2 3
)
3 4
;
4 5
string
 
resultReader
 
=
  !
string
" (
.
( )
Empty
) .
;
. /
string
 
worksheetsName
 !
=
" #
$str
$ +
;
+ ,
var
 
format
 
=
 
new
 
ExcelTextFormat
 ,
(
, -
)
- .
;
. /
format
 
.
 
	Delimiter
 
=
 
$char
 "
;
" #
format
กก 
.
กก 
TextQualifier
กก  
=
กก! "
$char
กก# &
;
กก& '
ExcelPackage
ขข 
.
ขข 
LicenseContext
ขข '
=
ขข( )
LicenseContext
ขข* 8
.
ขข8 9
NonCommercial
ขข9 F
;
ขขF G
string
คค 
?
คค !
fechaPosicionPivote
คค '
=
คค( )
string
คค* 0
.
คค0 1
Empty
คค1 6
;
คค6 7
List
ฅฅ 
<
ฅฅ 

Portafolio
ฅฅ 
>
ฅฅ 
portafoliosList
ฅฅ ,
=
ฅฅ- .
new
ฅฅ/ 2
List
ฅฅ3 7
<
ฅฅ7 8

Portafolio
ฅฅ8 B
>
ฅฅB C
(
ฅฅC D
)
ฅฅD E
!
ฅฅE F
;
ฅฅF G

Dictionary
งง 
<
งง 
int
งง 
,
งง 
string
งง "
?
งง" #
>
งง# $
dictionaryDates
งง% 4
=
งง5 6
new
งง7 :

Dictionary
งง; E
<
งงE F
int
งงF I
,
งงI J
string
งงK Q
?
งงQ R
>
งงR S
(
งงS T
)
งงT U
!
งงU V
;
งงV W

Dictionary
จจ 
<
จจ 
int
จจ 
,
จจ 
string
จจ "
?
จจ" #
>
จจ# $
dictionaryData
จจ% 3
=
จจ4 5
new
จจ6 9

Dictionary
จจ: D
<
จจD E
int
จจE H
,
จจH I
string
จจJ P
?
จจP Q
>
จจQ R
(
จจR S
)
จจS T
!
จจT U
;
จจU V
try
ชช 
{
ซซ 
var
ญญ 
subPortafolioList
ญญ %
=
ญญ& '
await
ญญ( -
this
ญญ. 2
.
ญญ2 3
GetSubPortfolios
ญญ3 C
(
ญญC D
)
ญญD E
;
ญญE F
if
ฎฎ 
(
ฎฎ 
!
ฎฎ 
subPortafolioList
ฎฎ &
.
ฎฎ& '
Any
ฎฎ' *
(
ฎฎ* +
)
ฎฎ+ ,
)
ฎฎ, -
{
ฏฏ 
response
ฐฐ 
.
ฐฐ 
Mensaje
ฐฐ $
=
ฐฐ% &
$str
ฐฐ' a
;
ฐฐa b
response
ฑฑ 
.
ฑฑ 
	IsExitoso
ฑฑ &
=
ฑฑ' (
false
ฑฑ) .
;
ฑฑ. /
response
ฒฒ 
.
ฒฒ 

StatusCode
ฒฒ '
=
ฒฒ( )
HttpStatusCode
ฒฒ* 8
.
ฒฒ8 9

BadRequest
ฒฒ9 C
;
ฒฒC D
return
ณณ 
response
ณณ #
;
ณณ# $
}
ดด 
ExcelWorksheet
ถถ 
?
ถถ 
	worksheet
ถถ  )
=
ถถ* +
null
ถถ, 0
;
ถถ0 1
using
ทท 
(
ทท 
var
ทท 
reader
ทท !
=
ทท" #
new
ทท$ '
System
ทท( .
.
ทท. /
IO
ทท/ 1
.
ทท1 2
StreamReader
ทท2 >
(
ทท> ?
file
ทท? C
.
ททC D
OpenReadStream
ททD R
(
ททR S
)
ททS T
)
ททT U
)
ททU V
using
ธธ 
(
ธธ 
ExcelPackage
ธธ #
package
ธธ$ +
=
ธธ, -
new
ธธ. 1
ExcelPackage
ธธ2 >
(
ธธ> ?
)
ธธ? @
)
ธธ@ A
{
นน 
resultReader
บบ  
=
บบ! "
await
บบ# (
reader
บบ) /
.
บบ/ 0
ReadToEndAsync
บบ0 >
(
บบ> ?
)
บบ? @
;
บบ@ A
	worksheet
ปป 
=
ปป 
package
ปป  '
?
ปป' (
.
ปป( )
Workbook
ปป) 1
.
ปป1 2

Worksheets
ปป2 <
.
ปป< =
Add
ปป= @
(
ปป@ A
worksheetsName
ปปA O
)
ปปO P
;
ปปP Q
	worksheet
ผผ 
=
ผผ 
package
ผผ  '
?
ผผ' (
.
ผผ( )
Workbook
ผผ) 1
.
ผผ1 2

Worksheets
ผผ2 <
[
ผผ< =
$num
ผผ= >
]
ผผ> ?
;
ผผ? @
	worksheet
ฝฝ 
!
ฝฝ 
.
ฝฝ 
Cells
ฝฝ $
[
ฝฝ$ %
$str
ฝฝ% )
]
ฝฝ) *
.
ฝฝ* +
LoadFromText
ฝฝ+ 7
(
ฝฝ7 8
resultReader
ฝฝ8 D
,
ฝฝD E
format
ฝฝF L
)
ฝฝL M
;
ฝฝM N!
fechaPosicionPivote
ภภ '
=
ภภ( )
	worksheet
ภภ* 3
.
ภภ3 4
Cells
ภภ4 9
[
ภภ9 :
$num
ภภ: ;
,
ภภ; <
$num
ภภ= >
]
ภภ> ?
.
ภภ? @
Value
ภภ@ E
?
ภภE F
.
ภภF G
ToString
ภภG O
(
ภภO P
)
ภภP Q
?
ภภQ R
.
ภภR S
Trim
ภภS W
(
ภภW X
)
ภภX Y
;
ภภY Z
if
มม 
(
มม 
string
มม 
.
มม 
IsNullOrEmpty
มม ,
(
มม, -!
fechaPosicionPivote
มม- @
)
มม@ A
)
มมA B
{
ยย 
response
รร  
.
รร  !
Mensaje
รร! (
=
รร) *
$str
รร+ d
;
รรd e
response
ฤฤ  
.
ฤฤ  !
	IsExitoso
ฤฤ! *
=
ฤฤ+ ,
false
ฤฤ- 2
;
ฤฤ2 3
response
ลล  
.
ลล  !

StatusCode
ลล! +
=
ลล, -
HttpStatusCode
ลล. <
.
ลล< =

BadRequest
ลล= G
;
ลลG H
return
ฦฦ 
response
ฦฦ '
;
ฦฦ' (
}
วว 
dictionaryDates
สส #
=
สส$ %
this
สส& *
.
สส* +
GetDateList
สส+ 6
(
สส6 7
	worksheet
สส7 @
)
สส@ A
;
สสA B
if
หห 
(
หห 
!
หห 
dictionaryDates
หห (
.
หห( )
Any
หห) ,
(
หห, -
)
หห- .
&&
หห/ 1
dictionaryDates
หห2 A
.
หหA B
Count
หหB G
==
หหH J
$num
หหK L
)
หหL M
{
ฬฬ 
response
ออ  
.
ออ  !
Mensaje
ออ! (
=
ออ) *
$str
ออ+ `
;
ออ` a
response
ฮฮ  
.
ฮฮ  !
	IsExitoso
ฮฮ! *
=
ฮฮ+ ,
false
ฮฮ- 2
;
ฮฮ2 3
response
ฯฯ  
.
ฯฯ  !

StatusCode
ฯฯ! +
=
ฯฯ, -
HttpStatusCode
ฯฯ. <
.
ฯฯ< =

BadRequest
ฯฯ= G
;
ฯฯG H
return
ะะ 
response
ะะ '
;
ะะ' (
}
ัั 

Portafolio
ำำ 
newPortafolio
ำำ ,
=
ำำ- .
new
ำำ/ 2

Portafolio
ำำ3 =
(
ำำ= >
)
ำำ> ?
!
ำำ? @
;
ำำ@ A
int
ิิ 
colCount
ิิ  
=
ิิ! "
	worksheet
ิิ# ,
.
ิิ, -
	Dimension
ิิ- 6
.
ิิ6 7
End
ิิ7 :
.
ิิ: ;
Column
ิิ; A
;
ิิA B
int
ีี 
rowCount
ีี  
=
ีี! "
	worksheet
ีี# ,
.
ีี, -
	Dimension
ีี- 6
.
ีี6 7
End
ีี7 :
.
ีี: ;
Row
ีี; >
;
ีี> ?
for
ุุ 
(
ุุ 
int
ุุ 
row
ุุ  
=
ุุ! "
$num
ุุ# $
;
ุุ$ %
row
ุุ& )
<=
ุุ* ,
rowCount
ุุ- 5
;
ุุ5 6
row
ุุ7 :
++
ุุ: <
)
ุุ< =
{
ูู 
dictionaryData
ฺฺ &
=
ฺฺ' (
new
ฺฺ) ,

Dictionary
ฺฺ- 7
<
ฺฺ7 8
int
ฺฺ8 ;
,
ฺฺ; <
string
ฺฺ= C
?
ฺฺC D
>
ฺฺD E
(
ฺฺE F
)
ฺฺF G
!
ฺฺG H
;
ฺฺH I
newPortafolio
 %
=
& '
new
( +

Portafolio
, 6
{
 

F_Posicion
 &
=
' (!
fechaPosicionPivote
) <
,
< =
NombrePortafolio
 ,
=
- .
$str
/ 6
,
6 7
No_Envio
฿฿ $
=
฿฿% &
$num
฿฿' (
,
฿฿( )
FechaCreacion
เเ )
=
เเ* +
DateTime
เเ, 4
.
เเ4 5
Now
เเ5 8
,
เเ8 9
FechaModificacion
แแ -
=
แแ. /
DateTime
แแ0 8
.
แแ8 9
Now
แแ9 <
}
โโ 
;
โโ 
for
ไไ 
(
ไไ 
int
ไไ  
col
ไไ! $
=
ไไ% &
$num
ไไ' (
;
ไไ( )
col
ไไ* -
<=
ไไ. 0
colCount
ไไ1 9
;
ไไ9 :
col
ไไ; >
++
ไไ> @
)
ไไ@ A
{
ๅๅ 
string
ๆๆ "
?
ๆๆ" #
currentCellValue
ๆๆ$ 4
=
ๆๆ5 6
	worksheet
ๆๆ7 @
.
ๆๆ@ A
Cells
ๆๆA F
[
ๆๆF G
row
ๆๆG J
,
ๆๆJ K
col
ๆๆL O
]
ๆๆO P
.
ๆๆP Q
Value
ๆๆQ V
?
ๆๆV W
.
ๆๆW X
ToString
ๆๆX `
(
ๆๆ` a
)
ๆๆa b
?
ๆๆb c
.
ๆๆc d
Trim
ๆๆd h
(
ๆๆh i
)
ๆๆi j
;
ๆๆj k
if
็็ 
(
็็  
!
็็  !
string
็็! '
.
็็' (
IsNullOrEmpty
็็( 5
(
็็5 6
currentCellValue
็็6 F
)
็็F G
)
็็G H
{
่่ 
if
๊๊  "
(
๊๊# $
col
๊๊$ '
==
๊๊( *
$num
๊๊+ ,
)
๊๊, -
{
๋๋  !
string
์์$ *
?
์์* +
subPortfolio
์์, 8
=
์์9 :
currentCellValue
์์; K
.
์์K L
ToUpper
์์L S
(
์์S T
)
์์T U
;
์์U V
newPortafolio
๎๎$ 1
.
๎๎1 2
SubPortafolioId
๎๎2 A
=
๎๎B C
this
๎๎D H
.
๎๎H I"
GetSubPortfolioValue
๎๎I ]
(
๎๎] ^
subPortafolioList
๎๎^ o
,
๎๎o p
subPortfolio
๎๎q }
)
๎๎} ~
;
๎๎~ 
if
๐๐$ &
(
๐๐' (
newPortafolio
๐๐( 5
.
๐๐5 6
SubPortafolioId
๐๐6 E
==
๐๐F H
$num
๐๐I J
)
๐๐J K
{
๑๑$ %
response
๒๒( 0
.
๒๒0 1
ErrorMessages
๒๒1 >
.
๒๒> ?
Add
๒๒? B
(
๒๒B C
$"
๒๒C E
$str
๒๒E n
{
๒๒n o
Environment
๒๒o z
.
๒๒z {
NewLine๒๒{ 
}๒๒ 
$str๒๒ ถ
{๒๒ถ ท
row๒๒ท บ
}๒๒บ ป
$str๒๒ป ฝ
{๒๒ฝ พ
col๒๒พ ม
}๒๒ม ย
$str๒๒ย ศ
{๒๒ศ ษ
subPortfolio๒๒ษ ี
}๒๒ี ึ
$str๒๒ึ ุ
"๒๒ุ ู
)๒๒ู ฺ
;๒๒ฺ 
}
๓๓$ %
}
๔๔  !
if
๖๖  "
(
๖๖# $
col
๖๖$ '
>
๖๖( )
$num
๖๖* +
&&
๖๖, .
subPortafolioList
๖๖/ @
.
๖๖@ A
Any
๖๖A D
(
๖๖D E
x
๖๖E F
=>
๖๖G I
x
๖๖J K
.
๖๖K L
SubPortafolioId
๖๖L [
==
๖๖\ ^
newPortafolio
๖๖_ l
.
๖๖l m
SubPortafolioId
๖๖m |
)
๖๖| }
)
๖๖} ~
{
๗๗  !
dictionaryData
๘๘$ 2
.
๘๘2 3
Add
๘๘3 6
(
๘๘6 7
col
๘๘7 :
,
๘๘: ;
currentCellValue
๘๘< L
)
๘๘L M
;
๘๘M N
}
๙๙  !
}
๚๚ 
}
๛๛ 
if
 
(
 
newPortafolio
 )
!=
* ,
null
- 1
&&
2 4
newPortafolio
5 B
.
B C
SubPortafolioId
C R
>
S T
$num
U V
)
V W
{
 
bool
  
isKeysTheSame
! .
=
/ 0
dictionaryDates
1 @
.
@ A
Count
A F
==
G I
dictionaryData
J X
.
X Y
Count
Y ^
&&
_ a
!
b c
dictionaryDates
c r
.
r s
Keys
s w
.
w x
Except
x ~
(
~ 
dictionaryData 
. 
Keys 
) 
. 
Any 
( 
) 
; 
if
 
(
  
!
  !
isKeysTheSame
! .
)
. /
{
 
response
  (
.
( )
Mensaje
) 0
=
1 2
$str
3 d
;
d e
response
  (
.
( )
ErrorMessages
) 6
.
6 7
Add
7 :
(
: ;
$"
; =
$str
= C
{
C D
row
D G
}
G H
$strH 
" 
) 
; 
response
  (
.
( )
	IsExitoso
) 2
=
3 4
false
5 :
;
: ;
response
  (
.
( )

StatusCode
) 3
=
4 5
HttpStatusCode
6 D
.
D E

BadRequest
E O
;
O P
return
  &
response
' /
;
/ 0
}
 
var
 
datos
  %
=
& '
(
( )
from
) -
f
. /
in
0 2
dictionaryDates
3 B
join
) -
d
. /
in
0 2
dictionaryData
3 A
on
B D
f
E F
.
F G
Key
G J
equals
K Q
d
R S
.
S T
Key
T W
select
) /
new
0 3
{
4 5
Fecha
6 ;
=
< =
f
> ?
.
? @
Value
@ E
,
E F
Valor
G L
=
M N
d
O P
.
P Q
Value
Q V
}
W X
)
X Y
.
Y Z
ToList
Z `
(
` a
)
a b
;
b c
if
 
(
  
datos
  %
!=
& (
null
) -
)
- .
{
 
newPortafolio
  -
.
- .

ListaDatos
. 8
=
9 :
JsonSerializer
; I
.
I J
	Serialize
J S
(
S T
datos
T Y
)
Y Z
;
Z [
}
 
portafoliosList
 +
.
+ ,
Add
, /
(
/ 0
newPortafolio
0 =
)
= >
;
> ?
}
 
}
 
var
 
result
 
=
  
await
! &"
_portfolioRepository
' ;
.
; < 
SavePortfoliosList
< N
(
N O
portafoliosList
O ^
)
^ _
;
_ `
response
 
.
 
ErrorMessages
 *
.
* +
AddRange
+ 3
(
3 4
result
4 :
)
: ;
;
; <
}
 
if
 
(
 
this
 
.
 
procedencia
 $
==
% '

originList
( 2
[
2 3
$num
3 4
]
4 5
!
5 6
)
6 7
{
 
var
กก 
saved
กก 
=
กก 
await
กก  %
this
กก& *
.
กก* +
SaveBackUpServer
กก+ ;
(
กก; <
)
กก< =
;
กก= >
if
ขข 
(
ขข 
!
ขข 
saved
ขข 
.
ขข 
	IsExitoso
ขข (
)
ขข( )
{
ฃฃ 
response
คค  
.
คค  !
ErrorMessages
คค! .
.
คค. /
Add
คค/ 2
(
คค2 3
saved
คค3 8
.
คค8 9
Mensaje
คค9 @
!
คค@ A
)
คคA B
;
คคB C
}
ฅฅ 
}
ฆฆ 
else
งง 
{
งง 
var
ฉฉ 
saved
ฉฉ 
=
ฉฉ 
await
ฉฉ  %
this
ฉฉ& *
.
ฉฉ* + 
SaveBackUpEndPoint
ฉฉ+ =
(
ฉฉ= >
file
ฉฉ> B
)
ฉฉB C
;
ฉฉC D
if
ชช 
(
ชช 
!
ชช 
saved
ชช 
.
ชช 
	IsExitoso
ชช (
)
ชช( )
{
ซซ 
response
ฌฌ  
.
ฌฌ  !
ErrorMessages
ฌฌ! .
.
ฌฌ. /
Add
ฌฌ/ 2
(
ฌฌ2 3
saved
ฌฌ3 8
.
ฌฌ8 9
Mensaje
ฌฌ9 @
!
ฌฌ@ A
)
ฌฌA B
;
ฌฌB C
}
ญญ 
}
ฎฎ 
if
ฑฑ 
(
ฑฑ 
this
ฑฑ 
.
ฑฑ 
procedencia
ฑฑ $
==
ฑฑ% '

originList
ฑฑ( 2
[
ฑฑ2 3
$num
ฑฑ3 4
]
ฑฑ4 5
!
ฑฑ5 6
)
ฑฑ6 7
{
ฒฒ 
var
ณณ 
moved
ณณ 
=
ณณ 
await
ณณ  %
this
ณณ& *
.
ณณ* +$
MoveFileToServerFolder
ณณ+ A
(
ณณA B
)
ณณB C
;
ณณC D
if
ดด 
(
ดด 
!
ดด 
moved
ดด 
.
ดด 
	IsExitoso
ดด (
)
ดด( )
{
ตต 
response
ถถ  
.
ถถ  !
ErrorMessages
ถถ! .
.
ถถ. /
Add
ถถ/ 2
(
ถถ2 3
moved
ถถ3 8
.
ถถ8 9
Mensaje
ถถ9 @
!
ถถ@ A
)
ถถA B
;
ถถB C
}
ทท 
}
ธธ 
response
บบ 
.
บบ 
	IsExitoso
บบ "
=
บบ# $
true
บบ% )
;
บบ) *
response
ปป 
.
ปป 
Mensaje
ปป  
=
ปป! "
$str
ปป# A
;
ปปA B
response
ผผ 
.
ผผ 
	Resultado
ผผ "
=
ผผ# $
true
ผผ% )
;
ผผ) *
response
ฝฝ 
.
ฝฝ 

StatusCode
ฝฝ #
=
ฝฝ$ %
HttpStatusCode
ฝฝ& 4
.
ฝฝ4 5
OK
ฝฝ5 7
;
ฝฝ7 8
}
พพ 
catch
ฟฟ 
(
ฟฟ "
KeyNotFoundException
ฟฟ '
ke
ฟฟ( *
)
ฟฟ* +
{
ภภ 
response
มม 
.
มม 
	IsExitoso
มม "
=
มม# $
false
มม% *
;
มม* +
response
ยย 
.
ยย 
ErrorMessages
ยย &
.
ยย& '
Add
ยย' *
(
ยย* +
$"
ยย+ -
$str
ยย- >
{
ยย> ?$
ExceptionMessageHelper
ยย? U
.
ยยU V!
GetExceptionMessage
ยยV i
(
ยยi j
ke
ยยj l
)
ยยl m
}
ยยm n
"
ยยn o
)
ยยo p
;
ยยp q
response
รร 
.
รร 

StatusCode
รร #
=
รร$ %
HttpStatusCode
รร& 4
.
รร4 5

BadRequest
รร5 ?
;
รร? @
response
ฤฤ 
.
ฤฤ 
	Resultado
ฤฤ "
=
ฤฤ# $
false
ฤฤ% *
;
ฤฤ* +
return
ลล 
response
ลล 
;
ลล  
}
ฦฦ 
catch
วว 
(
วว 
	Exception
วว 
ex
วว 
)
วว  
{
ศศ 
response
ษษ 
.
ษษ 
	IsExitoso
ษษ "
=
ษษ# $
false
ษษ% *
;
ษษ* +
response
สส 
.
สส 
ErrorMessages
สส &
.
สส& '
Add
สส' *
(
สส* +$
ExceptionMessageHelper
สส+ A
.
สสA B!
GetExceptionMessage
สสB U
(
สสU V
ex
สสV X
)
สสX Y
)
สสY Z
;
สสZ [
response
หห 
.
หห 

StatusCode
หห #
=
หห$ %
HttpStatusCode
หห& 4
.
หห4 5

BadRequest
หห5 ?
;
หห? @
response
ฬฬ 
.
ฬฬ 
	Resultado
ฬฬ "
=
ฬฬ# $
false
ฬฬ% *
;
ฬฬ* +
return
ออ 
response
ออ 
;
ออ  
}
ฮฮ 
return
ะะ 
response
ะะ 
;
ะะ 
}
ัั 	
private
ุุ 

Dictionary
ุุ 
<
ุุ 
int
ุุ 
,
ุุ 
string
ุุ  &
?
ุุ& '
>
ุุ' (
GetDateList
ุุ) 4
(
ุุ4 5
ExcelWorksheet
ุุ5 C
	worksheet
ุุD M
)
ุุM N
{
ูู 	

Dictionary
ฺฺ 
<
ฺฺ 
int
ฺฺ 
,
ฺฺ 
string
ฺฺ "
?
ฺฺ" #
>
ฺฺ# $
dateList
ฺฺ% -
=
ฺฺ. /
new
ฺฺ0 3

Dictionary
ฺฺ4 >
<
ฺฺ> ?
int
ฺฺ? B
,
ฺฺB C
string
ฺฺD J
?
ฺฺJ K
>
ฺฺK L
(
ฺฺL M
)
ฺฺM N
;
ฺฺN O
int
 
colCount
 
=
 
	worksheet
 $
.
$ %
	Dimension
% .
.
. /
End
/ 2
.
2 3
Column
3 9
;
9 :
for
 
(
 
int
 
col
 
=
 
$num
 
;
 
col
 !
<=
" $
colCount
% -
;
- .
col
/ 2
++
2 4
)
4 5
{
 
string
฿฿ 
?
฿฿ 
currentCellValue
฿฿ (
=
฿฿) *
	worksheet
฿฿+ 4
.
฿฿4 5
Cells
฿฿5 :
[
฿฿: ;
rowDate
฿฿; B
,
฿฿B C
col
฿฿D G
]
฿฿G H
.
฿฿H I
Value
฿฿I N
?
฿฿N O
.
฿฿O P
ToString
฿฿P X
(
฿฿X Y
)
฿฿Y Z
?
฿฿Z [
.
฿฿[ \
Trim
฿฿\ `
(
฿฿` a
)
฿฿a b
;
฿฿b c
if
เเ 
(
เเ 
!
เเ 
string
เเ 
.
เเ 
IsNullOrEmpty
เเ )
(
เเ) *
currentCellValue
เเ* :
)
เเ: ;
)
เเ; <
{
แแ 
dateList
โโ 
.
โโ 
Add
โโ  
(
โโ  !
col
โโ! $
,
โโ$ %
currentCellValue
โโ& 6
)
โโ6 7
;
โโ7 8
}
ใใ 
}
ไไ 
return
ๆๆ 
dateList
ๆๆ 
;
ๆๆ 
}
็็ 	
private
ํํ 
async
ํํ 
Task
ํํ 
<
ํํ 
IEnumerable
ํํ &
<
ํํ& '
SubPortafolios
ํํ' 5
>
ํํ5 6
>
ํํ6 7
GetSubPortfolios
ํํ8 H
(
ํํH I
)
ํํI J
{
๎๎ 	
var
๏๏ 
response
๏๏ 
=
๏๏ 
await
๏๏  "
_portfolioRepository
๏๏! 5
.
๏๏5 6&
GetAllSubPortfoliosAsync
๏๏6 N
(
๏๏N O
)
๏๏O P
;
๏๏P Q
return
๐๐ 
response
๐๐ 
;
๐๐ 
}
๑๑ 	
private
๙๙ 
int
๙๙ "
GetSubPortfolioValue
๙๙ (
(
๙๙( )
IEnumerable
๙๙) 4
<
๙๙4 5
SubPortafolios
๙๙5 C
>
๙๙C D
subPortfolioList
๙๙E U
,
๙๙U V
string
๙๙W ]
?
๙๙] ^
value
๙๙_ d
)
๙๙d e
{
๚๚ 	
int
๛๛ 
id
๛๛ 
=
๛๛ 
$num
๛๛ 
;
๛๛ 
if
 
(
 
!
 
string
 
.
 
IsNullOrEmpty
 %
(
% &
value
& +
)
+ ,
)
, -
{
 
id
 
=
 
subPortfolioList
 %
.
% &
Where
& +
(
+ ,
x
, -
=>
. 0
x
1 2
.
2 3
Descripcion
3 >
?
> ?
.
? @
Trim
@ D
(
D E
)
E F
.
F G
ToUpper
G N
(
N O
)
O P
==
Q S
value
T Y
.
Y Z
Trim
Z ^
(
^ _
)
_ `
.
` a
ToUpper
a h
(
h i
)
i j
)
j k
.
k l
Select
l r
(
r s
y
s t
=>
u w
y
x y
.
y z
SubPortafolioIdz 
) 
. 
FirstOrDefault 
( 
) 
; 
}
 
return
 
id
 
;
 
}
 	
private
 
ResponseDTO
 
ValidateFileExist
 -
(
- .
ref
. 1
	IFormFile
2 ;
file
< @
)
@ A
{
 	
ResponseDTO
 
response
  
=
! "
new
# &
ResponseDTO
' 2
{
3 4
	IsExitoso
5 >
=
? @
false
A F
}
G H
;
H I
this
 
.
 
procedencia
 
=
 

originList
 )
[
) *
$num
* +
]
+ ,
!
, -
;
- .
if
 
(
 
file
 
!=
 
null
 
&&
 
file
  $
!
$ %
.
% &
Length
& ,
>
- .
$num
/ 0
)
0 1
{
 
response
 
.
 
	IsExitoso
 "
=
# $
true
% )
;
) *
response
 
.
 

StatusCode
 #
=
$ %
HttpStatusCode
& 4
.
4 5
OK
5 7
;
7 8
return
 
response
 
;
  
}
 
if
 
(
 
file
 
==
 
null
 
||
 
file
  $
.
$ %
Length
% +
==
, .
$num
/ 0
)
0 1
{
 
string
 &
pathServerFolderComplete
 /
=
0 1
@$"
2 5
{
5 6
this
6 :
.
: ;%
uploadServerFileUrlPath
; R
}
R S
{
S T
this
T X
.
X Y&
uploadServerFolderSource
Y q
}
q r
{
r s
this
s w
.
w x
fileNamex 
} 
" 
; 
if
 
(
 
File
 
.
 
Exists
 
(
  &
pathServerFolderComplete
  8
)
8 9
)
9 :
{
 
if
 
(
 &
pathServerFolderComplete
 0
.
0 1
ToLower
1 8
(
8 9
)
9 :
.
: ;
EndsWith
; C
(
C D
$str
D J
)
J K
)
K L
{
 
var
ขข 
provider
ขข $
=
ขข% &
new
ขข' *.
 FileExtensionContentTypeProvider
ขข+ K
(
ขขK L
)
ขขL M
;
ขขM N
string
ฃฃ 
tmpContentType
ฃฃ -
=
ฃฃ. /
string
ฃฃ0 6
.
ฃฃ6 7
Empty
ฃฃ7 <
;
ฃฃ< =
if
คค 
(
คค 
!
คค 
provider
คค %
.
คค% &
TryGetContentType
คค& 7
(
คค7 8
fileName
คค8 @
!
คค@ A
,
คคA B
out
คคC F
tmpContentType
คคG U
!
คคU V
)
คคV W
)
คคW X
{
ฅฅ 
tmpContentType
ฆฆ *
=
ฆฆ+ ,
$str
ฆฆ- 3
;
ฆฆ3 4
}
งง 
if
จจ 
(
จจ 
contentType
จจ '
!=
จจ( *
tmpContentType
จจ+ 9
)
จจ9 :
{
ฉฉ 
response
ชช $
.
ชช$ %
Mensaje
ชช% ,
=
ชช- .
$str
ชช/ u
;
ชชu v
response
ซซ $
.
ซซ$ %

StatusCode
ซซ% /
=
ซซ0 1
HttpStatusCode
ซซ2 @
.
ซซ@ A

BadRequest
ซซA K
;
ซซK L
return
ฌฌ "
response
ฌฌ# +
;
ฌฌ+ ,
}
ญญ 
string
ฐฐ 
name
ฐฐ #
=
ฐฐ$ %
Path
ฐฐ& *
.
ฐฐ* +)
GetFileNameWithoutExtension
ฐฐ+ F
(
ฐฐF G&
pathServerFolderComplete
ฐฐG _
)
ฐฐ_ `
;
ฐฐ` a
string
ฑฑ 
fileContent
ฑฑ *
=
ฑฑ+ ,
File
ฑฑ- 1
.
ฑฑ1 2
ReadAllText
ฑฑ2 =
(
ฑฑ= >&
pathServerFolderComplete
ฑฑ> V
)
ฑฑV W
;
ฑฑW X
byte
ฒฒ 
[
ฒฒ 
]
ฒฒ 
	byteArray
ฒฒ (
=
ฒฒ) *
Encoding
ฒฒ+ 3
.
ฒฒ3 4
UTF8
ฒฒ4 8
.
ฒฒ8 9
GetBytes
ฒฒ9 A
(
ฒฒA B
fileContent
ฒฒB M
)
ฒฒM N
;
ฒฒN O
var
ณณ 
memoryStream
ณณ (
=
ณณ) *
new
ณณ+ .
MemoryStream
ณณ/ ;
(
ณณ; <
	byteArray
ณณ< E
)
ณณE F
;
ณณF G
	IFormFile
ตต !
archivoForm
ตต" -
=
ตต. /
new
ตต0 3
FormFile
ตต4 <
(
ตต< =
memoryStream
ตต= I
,
ตตI J
$num
ตตK L
,
ตตL M
	byteArray
ตตN W
.
ตตW X
Length
ตตX ^
,
ตต^ _
name
ตต` d
,
ตตd e
fileName
ตตf n
!
ตตn o
)
ตตo p
;
ตตp q
file
ถถ 
=
ถถ 
archivoForm
ถถ *
;
ถถ* +
response
ทท  
.
ทท  !
	IsExitoso
ทท! *
=
ทท+ ,
true
ทท- 1
;
ทท1 2
response
ธธ  
.
ธธ  !

StatusCode
ธธ! +
=
ธธ, -
HttpStatusCode
ธธ. <
.
ธธ< =
OK
ธธ= ?
;
ธธ? @
this
นน 
.
นน 
procedencia
นน (
=
นน) *

originList
นน+ 5
[
นน5 6
$num
นน6 7
]
นน7 8
!
นน8 9
;
นน9 :
}
บบ 
else
ปป 
{
ผผ 
response
ฝฝ  
.
ฝฝ  !
Mensaje
ฝฝ! (
=
ฝฝ) *
$str
ฝฝ+ 8
+
ฝฝ9 :&
pathServerFolderComplete
ฝฝ; S
+
ฝฝT U
$str
ฝฝV g
;
ฝฝg h
response
พพ  
.
พพ  !

StatusCode
พพ! +
=
พพ, -
HttpStatusCode
พพ. <
.
พพ< =

BadRequest
พพ= G
;
พพG H
}
ฟฟ 
}
ภภ 
else
มม 
{
ยย 
response
รร 
.
รร 
Mensaje
รร $
=
รร% &
$str
รร' 4
+
รร5 6&
pathServerFolderComplete
รร7 O
+
รรP Q
$str
รรR _
;
รร_ `
response
ฤฤ 
.
ฤฤ 

StatusCode
ฤฤ '
=
ฤฤ( )
HttpStatusCode
ฤฤ* 8
.
ฤฤ8 9

BadRequest
ฤฤ9 C
;
ฤฤC D
}
ลล 
}
ฦฦ 
if
ษษ 
(
ษษ 
file
ษษ 
==
ษษ 
null
ษษ 
||
ษษ 
file
ษษ  $
.
ษษ$ %
Length
ษษ% +
==
ษษ, .
$num
ษษ/ 0
)
ษษ0 1
{
สส 
response
หห 
.
หห 
Mensaje
หห  
=
หห! "
$str
หห# B
;
หหB C
response
ฬฬ 
.
ฬฬ 

StatusCode
ฬฬ #
=
ฬฬ$ %
HttpStatusCode
ฬฬ& 4
.
ฬฬ4 5

BadRequest
ฬฬ5 ?
;
ฬฬ? @
}
ออ 
return
ฯฯ 
response
ฯฯ 
;
ฯฯ 
}
ะะ 	
private
ึึ 
async
ึึ 
Task
ึึ 
<
ึึ 
ResponseDTO
ึึ &
>
ึึ& '$
MoveFileToServerFolder
ึึ( >
(
ึึ> ?
)
ึึ? @
{
ืื 	
ResponseDTO
ุุ 
response
ุุ  
=
ุุ! "
new
ุุ# &
ResponseDTO
ุุ' 2
{
ุุ3 4
	IsExitoso
ุุ5 >
=
ุุ? @
false
ุุA F
}
ุุG H
;
ุุH I
var
ฺฺ 
date
ฺฺ 
=
ฺฺ 
DateTime
ฺฺ 
.
ฺฺ  
Now
ฺฺ  #
.
ฺฺ# $
ToString
ฺฺ$ ,
(
ฺฺ, -
$str
ฺฺ- 0
)
ฺฺ0 1
.
ฺฺ1 2
Replace
ฺฺ2 9
(
ฺฺ9 :
$str
ฺฺ: =
,
ฺฺ= >
$str
ฺฺ? B
)
ฺฺB C
;
ฺฺC D
string
 
name
 
=
 
Path
 
.
 )
GetFileNameWithoutExtension
 :
(
: ;
this
; ?
.
? @
fileName
@ H
!
H I
)
I J
;
J K
string
 
	extension
 
=
 
Path
 #
.
# $
GetExtension
$ 0
(
0 1
fileName
1 9
!
9 :
)
: ;
;
; <
string
 

sourcePath
 
=
 
@$"
  #
{
# $
this
$ (
.
( )%
uploadServerFileUrlPath
) @
}
@ A
{
A B
this
B F
.
F G&
uploadServerFolderSource
G _
}
_ `
{
` a
this
a e
.
e f
fileName
f n
}
n o
"
o p
;
p q
string
฿฿ 
destinationPath
฿฿ "
=
฿฿# $
@$"
฿฿% (
{
฿฿( )
this
฿฿) -
.
฿฿- .'
downloadServerFileUrlPath
฿฿. G
}
฿฿G H
{
฿฿H I
this
฿฿I M
.
฿฿M N-
downloadServerFolderDestination
฿฿N m
}
฿฿m n
{
฿฿n o
name
฿฿o s
}
฿฿s t
$str
฿฿t v
{
฿฿v w
date
฿฿w {
}
฿฿{ |
$str
฿฿| }
{
฿฿} ~
	extension฿฿~ 
}฿฿ 
"฿฿ 
;฿฿ 
try
แแ 
{
โโ 
if
ไไ 
(
ไไ 
System
ไไ 
.
ไไ 
IO
ไไ 
.
ไไ 
File
ไไ "
.
ไไ" #
Exists
ไไ# )
(
ไไ) *

sourcePath
ไไ* 4
)
ไไ4 5
)
ไไ5 6
{
ๅๅ 
File
ๆๆ 
.
ๆๆ 
Move
ๆๆ 
(
ๆๆ 

sourcePath
ๆๆ (
,
ๆๆ( )
destinationPath
ๆๆ* 9
)
ๆๆ9 :
;
ๆๆ: ;
response
็็ 
.
็็ 
	IsExitoso
็็ &
=
็็' (
true
็็) -
;
็็- .
}
่่ 
else
้้ 
{
๊๊ 
response
๋๋ 
.
๋๋ 
Mensaje
๋๋ $
=
๋๋% &
$str
๋๋' 4
+
๋๋5 6

sourcePath
๋๋7 A
+
๋๋B C
$str
๋๋D Q
;
๋๋Q R
response
์์ 
.
์์ 

StatusCode
์์ '
=
์์( )
System
์์* 0
.
์์0 1
Net
์์1 4
.
์์4 5
HttpStatusCode
์์5 C
.
์์C D

BadRequest
์์D N
;
์์N O
}
ํํ 
}
๎๎ 
catch
๏๏ 
(
๏๏ 
	Exception
๏๏ 
ex
๏๏ 
)
๏๏  
{
๐๐ 
response
๑๑ 
.
๑๑ 
Mensaje
๑๑  
=
๑๑! "$
ExceptionMessageHelper
๑๑# 9
.
๑๑9 :!
GetExceptionMessage
๑๑: M
(
๑๑M N
ex
๑๑N P
)
๑๑P Q
;
๑๑Q R
response
๒๒ 
.
๒๒ 

StatusCode
๒๒ #
=
๒๒$ %
System
๒๒& ,
.
๒๒, -
Net
๒๒- 0
.
๒๒0 1
HttpStatusCode
๒๒1 ?
.
๒๒? @

BadRequest
๒๒@ J
;
๒๒J K
}
๓๓ 
return
๕๕ 
await
๕๕ 
Task
๕๕ 
.
๕๕ 

FromResult
๕๕ (
(
๕๕( )
response
๕๕) 1
)
๕๕1 2
;
๕๕2 3
}
๖๖ 	
private
 
async
 
Task
 
<
 
ResponseDTO
 &
>
& '
SaveBackUpServer
( 8
(
8 9
)
9 :
{
 	
ResponseDTO
 
response
  
=
! "
new
# &
ResponseDTO
' 2
{
3 4
	IsExitoso
5 >
=
? @
false
A F
}
G H
;
H I
var
 
date
 
=
 
DateTime
 
.
  
Now
  #
.
# $
ToString
$ ,
(
, -
$str
- 0
)
0 1
.
1 2
Replace
2 9
(
9 :
$str
: =
,
= >
$str
? B
)
B C
;
C D
string
 
name
 
=
 
Path
 
.
 )
GetFileNameWithoutExtension
 :
(
: ;
this
; ?
.
? @
fileName
@ H
!
H I
)
I J
;
J K
string
 
	extension
 
=
 
Path
 #
.
# $
GetExtension
$ 0
(
0 1
this
1 5
.
5 6
fileName
6 >
!
> ?
)
? @
;
@ A
string
 

sourcePath
 
=
 
@$"
  #
{
# $
this
$ (
.
( )%
uploadServerFileUrlPath
) @
}
@ A
{
A B
this
B F
.
F G&
uploadServerFolderSource
G _
}
_ `
{
` a
this
a e
.
e f
fileName
f n
}
n o
"
o p
;
p q
try
 
{
 
if
 
(
 
File
 
.
 
Exists
 
(
  

sourcePath
  *
)
* +
)
+ ,
{
 
byte
 
[
 
]
 
bytes
  
=
! "
await
# (
File
) -
.
- .
ReadAllBytesAsync
. ?
(
? @

sourcePath
@ J
)
J K
;
K L
string
 
originalName
 '
=
( )
fileName
* 2
!
2 3
;
3 4
string
 
compoundName
 '
=
( )
$"
* ,
{
, -
name
- 1
}
1 2
$str
2 4
{
4 5
date
5 9
}
9 :
$str
: ;
{
; <
	extension
< E
}
E F
"
F G
;
G H
var
 
result
 
=
  
await
! &"
_portfolioRepository
' ;
.
; <
SaveFileBase64
< J
(
J K
originalName
K W
,
W X
compoundName
Y e
,
e f
bytes
g l
,
l m
$str
n v
)
v w
;
w x
response
 
.
 
	IsExitoso
 &
=
' (
result
) /
;
/ 0
}
 
else
 
{
 
response
 
.
 
Mensaje
 $
=
% &
$str
' 4
+
5 6

sourcePath
7 A
+
B C
$str
D Q
;
Q R
response
 
.
 

StatusCode
 '
=
( )
System
* 0
.
0 1
Net
1 4
.
4 5
HttpStatusCode
5 C
.
C D

BadRequest
D N
;
N O
}
 
}
 
catch
 
(
 
	Exception
 
ex
 
)
  
{
 
response
 
.
 
Mensaje
  
=
! "$
ExceptionMessageHelper
# 9
.
9 :!
GetExceptionMessage
: M
(
M N
ex
N P
)
P Q
;
Q R
response
 
.
 

StatusCode
 #
=
$ %
System
& ,
.
, -
Net
- 0
.
0 1
HttpStatusCode
1 ?
.
? @

BadRequest
@ J
;
J K
}
 
return
ขข 
response
ขข 
;
ขข 
}
ฃฃ 	
private
ชช 
async
ชช 
Task
ชช 
<
ชช 
ResponseDTO
ชช &
>
ชช& ' 
SaveBackUpEndPoint
ชช( :
(
ชช: ;
	IFormFile
ชช; D
file
ชชE I
)
ชชI J
{
ซซ 	
ResponseDTO
ฌฌ 
response
ฌฌ  
=
ฌฌ! "
new
ฌฌ# &
ResponseDTO
ฌฌ' 2
{
ฌฌ3 4
	IsExitoso
ฌฌ5 >
=
ฌฌ? @
false
ฌฌA F
}
ฌฌG H
;
ฌฌH I
try
ฎฎ 
{
ฏฏ 
string
ฐฐ 
originalName
ฐฐ #
=
ฐฐ$ %
file
ฐฐ& *
.
ฐฐ* +
FileName
ฐฐ+ 3
;
ฐฐ3 4
var
ฑฑ 
date
ฑฑ 
=
ฑฑ 
DateTime
ฑฑ #
.
ฑฑ# $
Now
ฑฑ$ '
.
ฑฑ' (
ToString
ฑฑ( 0
(
ฑฑ0 1
$str
ฑฑ1 4
)
ฑฑ4 5
.
ฑฑ5 6
Replace
ฑฑ6 =
(
ฑฑ= >
$str
ฑฑ> A
,
ฑฑA B
$str
ฑฑC F
)
ฑฑF G
;
ฑฑG H
string
ฒฒ 
name
ฒฒ 
=
ฒฒ 
Path
ฒฒ "
.
ฒฒ" #)
GetFileNameWithoutExtension
ฒฒ# >
(
ฒฒ> ?
originalName
ฒฒ? K
)
ฒฒK L
;
ฒฒL M
string
ณณ 
	extension
ณณ  
=
ณณ! "
Path
ณณ# '
.
ณณ' (
GetExtension
ณณ( 4
(
ณณ4 5
originalName
ณณ5 A
)
ณณA B
;
ณณB C
string
ดด 
compoundName
ดด #
=
ดด$ %
$"
ดด& (
{
ดด( )
name
ดด) -
}
ดด- .
$str
ดด. 0
{
ดด0 1
date
ดด1 5
}
ดด5 6
$str
ดด6 7
{
ดด7 8
	extension
ดด8 A
}
ดดA B
"
ดดB C
;
ดดC D
using
ถถ 
(
ถถ 
MemoryStream
ถถ #
memoryStream
ถถ$ 0
=
ถถ1 2
new
ถถ3 6
MemoryStream
ถถ7 C
(
ถถC D
)
ถถD E
)
ถถE F
{
ทท 
await
ธธ 
file
ธธ 
.
ธธ 
CopyToAsync
ธธ *
(
ธธ* +
memoryStream
ธธ+ 7
)
ธธ7 8
;
ธธ8 9
byte
นน 
[
นน 
]
นน 
bytes
นน  
=
นน! "
memoryStream
นน# /
.
นน/ 0
ToArray
นน0 7
(
นน7 8
)
นน8 9
;
นน9 :
var
ศศ 
result
ศศ 
=
ศศ  
await
ศศ! &"
_portfolioRepository
ศศ' ;
.
ศศ; <
SaveFileBase64
ศศ< J
(
ศศJ K
originalName
ศศK W
,
ศศW X
compoundName
ศศY e
,
ศศe f
bytes
ศศg l
,
ศศl m
$str
ศศn x
)
ศศx y
;
ศศy z
response
ษษ 
.
ษษ 
	IsExitoso
ษษ &
=
ษษ' (
result
ษษ) /
;
ษษ/ 0
}
สส 
}
หห 
catch
ฬฬ 
(
ฬฬ 
	Exception
ฬฬ 
ex
ฬฬ 
)
ฬฬ  
{
ออ 
response
ฮฮ 
.
ฮฮ 
Mensaje
ฮฮ  
=
ฮฮ! "$
ExceptionMessageHelper
ฮฮ# 9
.
ฮฮ9 :!
GetExceptionMessage
ฮฮ: M
(
ฮฮM N
ex
ฮฮN P
)
ฮฮP Q
;
ฮฮQ R
response
ฯฯ 
.
ฯฯ 

StatusCode
ฯฯ #
=
ฯฯ$ %
System
ฯฯ& ,
.
ฯฯ, -
Net
ฯฯ- 0
.
ฯฯ0 1
HttpStatusCode
ฯฯ1 ?
.
ฯฯ? @

BadRequest
ฯฯ@ J
;
ฯฯJ K
}
ะะ 
return
าา 
response
าา 
;
าา 
}
ำำ 	
public
 
async
 
Task
 
<
 
ResponseDTO
 %
>
% &

GetFileCSV
' 1
(
1 2
string
2 8
fileDate
9 A
)
A B
{
 	
ResponseDTO
฿฿ 
response
฿฿  
=
฿฿! "
new
฿฿# &
ResponseDTO
฿฿' 2
{
฿฿3 4
	IsExitoso
฿฿5 >
=
฿฿? @
false
฿฿A F
}
฿฿G H
;
฿฿H I
try
แแ 
{
โโ 
response
ใใ 
=
ใใ 
await
ใใ  "
_portfolioRepository
ใใ! 5
.
ใใ5 6
ReadOracleBLOB
ใใ6 D
(
ใใD E
fileDate
ใใE M
)
ใใM N
;
ใใN O
}
ไไ 
catch
ๅๅ 
(
ๅๅ 
	Exception
ๅๅ 
ex
ๅๅ 
)
ๅๅ  
{
ๆๆ 
response
็็ 
.
็็ 
Mensaje
็็  
=
็็! "$
ExceptionMessageHelper
็็# 9
.
็็9 :!
GetExceptionMessage
็็: M
(
็็M N
ex
็็N P
)
็็P Q
;
็็Q R
response
่่ 
.
่่ 

StatusCode
่่ #
=
่่$ %
System
่่& ,
.
่่, -
Net
่่- 0
.
่่0 1
HttpStatusCode
่่1 ?
.
่่? @

BadRequest
่่@ J
;
่่J K
}
้้ 
return
๋๋ 
response
๋๋ 
;
๋๋ 
}
์์ 	
}
๎๎ 
}๐๐ ๗v
ซD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\UseCases\UserUseCase.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &
UseCases& .
{ 
public 

class 
UserUseCase 
: 
IUserUseCase +
{ 
private 
readonly $
IAuthorizationRepository 1$
_authorizationRepository2 J
;J K
private 
readonly 
IConfiguration '
_configuration( 6
;6 7
private 
readonly 
IUserRepository (
_userRepository) 8
;8 9
private 
readonly 
PasswordHasher '
<' (
Usuario( /
>/ 0
_passwordHasher1 @
;@ A
public 
UserUseCase 
( $
IAuthorizationRepository 3#
authorizationRepository4 K
,K L
IConfigurationM [
configuration\ i
,i j
IUserRepositoryk z
userRepository	{ 
)
 
{ 	$
_authorizationRepository $
=% &#
authorizationRepository' >
;> ?
_configuration 
= 
configuration *
;* +
_userRepository 
= 
userRepository ,
;, -
_passwordHasher 
= 
new !
PasswordHasher" 0
<0 1
Usuario1 8
>8 9
(9 :
): ;
;; <
}   	
public'' 
async'' 
Task'' 
<'' 
ResponseDTO'' %
>''% &
Login''' ,
('', -
LoginRequestDTO''- <
request''= D
)''D E
{(( 	
ResponseDTO)) 
response))  
=))! "
new))# &
ResponseDTO))' 2
())2 3
)))3 4
;))4 5
try++ 
{,, 
var-- 
allUsers-- 
=-- 
await-- $
_userRepository--% 4
.--4 5
GetAllAsync--5 @
(--@ A
)--A B
;--B C
var.. 
user.. 
=.. 
allUsers.. #
...# $
FirstOrDefault..$ 2
(..2 3
u..3 4
=>..5 7
u..8 9
...9 :
UserName..: B
...B C
Trim..C G
(..G H
)..H I
...I J
ToLower..J Q
(..Q R
)..R S
==..T V
request..W ^
...^ _
Username.._ g
!..g h
...h i
Trim..i m
(..m n
)..n o
...o p
ToLower..p w
(..w x
)..x y
)..y z
;..z {
var// 
result// 
=// 
this// !
.//! "
VerifyPassword//" 0
(//0 1
user//1 5
!//5 6
,//6 7
request//8 ?
.//? @
Password//@ H
!//H I
)//I J
;//J K
if11 
(11 
!11 
result11 
)11 
{22 
response33 
.33 
	IsExitoso33 &
=33' (
false33) .
;33. /
response44 
.44 
ErrorMessages44 *
.44* +
Add44+ .
(44. /
$str44/ R
)44R S
;44S T
response55 
.55 

StatusCode55 '
=55( )
HttpStatusCode55* 8
.558 9

BadRequest559 C
;55C D
return66 
response66 #
;66# $
}77 
string99 
	secretKey99  
=99! "
string99# )
.99) *
Empty99* /
;99/ 0
string:: 
environmentVariable:: *
=::+ ,
Environment::- 8
.::8 9"
GetEnvironmentVariable::9 O
(::O P
$str::P j
)::j k
!::k l
;::l m
if;; 
(;; 
!;; 
string;; 
.;; 
IsNullOrEmpty;; )
(;;) *
environmentVariable;;* =
);;= >
);;> ?
{<< 
var== 
data== 
=== 
JsonConvert== *
.==* +
DeserializeObject==+ <
<==< = 
EnvironmentVariables=== Q
>==Q R
(==R S
environmentVariable==S f
!==f g
)==g h
;==h i
	secretKey>> 
=>> 
data>>  $
!>>$ %
.>>% &
Secret>>& ,
;>>, -
}?? 
intAA 
accessTokenTimeAA #
=AA$ %
intAA& )
.AA) *
ParseAA* /
(AA/ 0
_configurationAA0 >
.AA> ?
GetValueAA? G
<AAG H
stringAAH N
>AAN O
(AAO P
$strAAP m
)AAm n
!AAn o
)AAo p
;AAp q
stringBB 
tokenCreatedBB #
=BB$ %
TokenHelperBB& 1
.BB1 2
GenerateAccessTokenBB2 E
(BBE F
userBBF J
!BBJ K
,BBK L
	secretKeyBBM V
,BBV W
accessTokenTimeBBX g
)BBg h
;BBh i
stringCC 
refreshTokenCreatedCC *
=CC+ ,
TokenHelperCC- 8
.CC8 9 
GenerateRefreshTokenCC9 M
(CCM N
)CCN O
;CCO P
intEE 
refreshTokenTimeEE $
=EE% &
intEE' *
.EE* +
ParseEE+ 0
(EE0 1
_configurationEE1 ?
.EE? @
GetValueEE@ H
<EEH I
stringEEI O
>EEO P
(EEP Q
$strEEQ o
)EEo p
!EEp q
)EEq r
;EEr s
responseFF 
=FF 
awaitFF  
TokenHelperFF! ,
.FF, -
SaveRefreshTokenFF- =
(FF= >
userFF> B
!FFB C
.FFC D
IdFFD F
,FFF G
tokenCreatedFFH T
,FFT U
refreshTokenCreatedFFV i
,FFi j
refreshTokenTimeFFk {
,FF{ |%
_authorizationRepository	FF} 
)
FF 
;
FF 
ifGG 
(GG 
responseGG 
.GG 
	IsExitosoGG &
)GG& '
{HH 
varJJ 
userDataJJ  
=JJ! "
newJJ# &
UserDTOJJ' .
{KK 
NombreLL 
=LL  
userLL! %
.LL% &
NombreLL& ,
,LL, -
UserNameMM  
=MM! "
userMM# '
.MM' (
UserNameMM( 0
}NN 
;NN 
varOO 
	tokenDataOO !
=OO" #
(OO$ %
TokenDTOOO% -
)OO- .
responseOO. 6
.OO6 7
	ResultadoOO7 @
!OO@ A
;OOA B
responseQQ 
.QQ 
	ResultadoQQ &
=QQ' (
newQQ) ,
{RR 
userNameSS  
=SS! "
userDataSS# +
.SS+ ,
UserNameSS, 4
,SS4 5
nombreTT 
=TT  
userDataTT! )
.TT) *
NombreTT* 0
,TT0 1
accessTokenUU #
=UU$ %
	tokenDataUU& /
.UU/ 0
AccessTokenUU0 ;
,UU; <
refreshTokenVV $
=VV% &
	tokenDataVV' 0
.VV0 1
RefreshTokenVV1 =
}WW 
;WW 
}XX 
}YY 
catchZZ 
(ZZ 
	ExceptionZZ 
exZZ 
)ZZ  
{[[ 
response\\ 
.\\ 
	IsExitoso\\ "
=\\# $
false\\% *
;\\* +
response]] 
.]] 
ErrorMessages]] &
.]]& '
Add]]' *
(]]* +"
ExceptionMessageHelper]]+ A
.]]A B
GetExceptionMessage]]B U
(]]U V
ex]]V X
)]]X Y
)]]Y Z
;]]Z [
response^^ 
.^^ 

StatusCode^^ #
=^^$ %
HttpStatusCode^^& 4
.^^4 5

BadRequest^^5 ?
;^^? @
}__ 
returnaa 
responseaa 
;aa 
}bb 	
publicii 
asyncii 
Taskii 
<ii 
ResponseDTOii %
>ii% &
Registerii' /
(ii/ 0
RegistroRequestDTOii0 B
requestiiC J
)iiJ K
{jj 	
ResponseDTOkk 
responsekk  
=kk! "
newkk# &
ResponseDTOkk' 2
(kk2 3
)kk3 4
;kk4 5
trymm 
{nn 
varoo 
isUsuarioUnicooo "
=oo# $
thisoo% )
.oo) *
IsUsuarioUnicooo* 8
(oo8 9
requestoo9 @
.oo@ A
UserNameooA I
)ooI J
;ooJ K
ifqq 
(qq 
isUsuarioUnicoqq "
)qq" #
{rr 
responsess 
.ss 
	IsExitososs &
=ss' (
falsess) .
;ss. /
responsett 
.tt 
ErrorMessagestt *
.tt* +
Addtt+ .
(tt. /
$strtt/ F
)ttF G
;ttG H
responseuu 
.uu 

StatusCodeuu '
=uu( )
HttpStatusCodeuu* 8
.uu8 9

BadRequestuu9 C
;uuC D
returnvv 
responsevv #
;vv# $
}ww 
Usuarioyy 
usuarioyy 
=yy  !
newyy" %
(yy% &
)yy& '
{zz 
Nombre{{ 
={{ 
request{{ $
.{{$ %
Nombre{{% +
,{{+ ,
Password|| 
=|| 
request|| &
.||& '
Password||' /
,||/ 0
Rol}} 
=}} 
request}} !
.}}! "
Rol}}" %
,}}% &
UserName~~ 
=~~ 
request~~ &
.~~& '
UserName~~' /
} 
; 
usuario
 
.
 
Password
  
=
! "
_passwordHasher
# 2
.
2 3
HashPassword
3 ?
(
? @
usuario
@ G
,
G H
request
I P
.
P Q
Password
Q Y
)
Y Z
;
Z [
var
 
userAdd
 
=
 
await
 #
_userRepository
$ 3
.
3 4
AddAsync
4 <
(
< =
usuario
= D
)
D E
;
E F
usuario
 
.
 
Id
 
=
 
this
 !
.
! "
GetUserByUserName
" 3
(
3 4
request
4 ;
.
; <
UserName
< D
)
D E
.
E F
Id
F H
;
H I
response
 
.
 
	IsExitoso
 "
=
# $
userAdd
% ,
>
- .
$num
/ 0
;
0 1
response
 
.
 
Mensaje
  
=
! "
response
# +
.
+ ,
	IsExitoso
, 5
?
6 7
$str
8 U
:
V W
$str
X z
;
z {
usuario
 
.
 
Password
  
=
! "
$str
# %
;
% &
response
 
.
 
	Resultado
 "
=
# $
usuario
% ,
;
, -
response
 
.
 

StatusCode
 #
=
$ %
HttpStatusCode
& 4
.
4 5
OK
5 7
;
7 8
}
 
catch
 
(
 
	Exception
 
ex
 
)
  
{
 
response
 
.
 
	IsExitoso
 "
=
# $
false
% *
;
* +
response
 
.
 
Mensaje
  
=
! "$
ExceptionMessageHelper
# 9
.
9 :!
GetExceptionMessage
: M
(
M N
ex
N P
)
P Q
;
Q R
response
 
.
 

StatusCode
 #
=
$ %
HttpStatusCode
& 4
.
4 5

BadRequest
5 ?
;
? @
}
 
return
 
response
 
;
 
}
 	
private
 
Usuario
 
GetUserByUserName
 )
(
) *
string
* 0
userName
1 9
)
9 :
{
 	
var
 
usuario
 
=
 
_userRepository
 )
.
) *
GetAllAsync
* 5
(
5 6
)
6 7
.
7 8
Result
8 >
.
> ?
FirstOrDefault
? M
(
M N
u
N O
=>
P R
u
S T
.
T U
UserName
U ]
.
] ^
ToLower
^ e
(
e f
)
f g
==
h j
userName
k s
.
s t
ToLower
t {
(
{ |
)
| }
)
} ~
;
~ 
return
 
usuario
 
!
 
;
 
}
 	
private
 
bool
 
IsUsuarioUnico
 #
(
# $
string
$ *
userName
+ 3
)
3 4
{
 	
var
 
usuario
 
=
 
_userRepository
 )
.
) *
GetAllAsync
* 5
(
5 6
)
6 7
.
7 8
Result
8 >
.
> ?
FirstOrDefault
? M
(
M N
u
N O
=>
P R
u
S T
.
T U
UserName
U ]
.
] ^
ToLower
^ e
(
e f
)
f g
==
h j
userName
k s
.
s t
ToLower
t {
(
{ |
)
| }
)
} ~
;
~ 
if
 
(
 
usuario
 
==
 
null
 
)
  
{
 
return
 
false
 
;
 
}
 
return
 
true
 
;
 
}
 	
public
 
bool
 
VerifyPassword
 "
(
" #
Usuario
# *
user
+ /
,
/ 0
string
1 7
password
8 @
)
@ A
{
 	
var
 
result
 
=
 
_passwordHasher
 (
.
( )"
VerifyHashedPassword
) =
(
= >
user
> B
,
B C
user
D H
.
H I
Password
I Q
,
Q R
password
S [
)
[ \
;
\ ]
return
 
result
 
==
 (
PasswordVerificationResult
 7
.
7 8
Success
8 ?
;
? @
}
 	
}
 
}กก :
ดD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\UseCases\AuthorizationUseCase.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &
UseCases& .
{ 
public 

class  
AuthorizationUseCase %
:& '!
IAuthorizationUseCase( =
{ 
private 
readonly $
IAuthorizationRepository 1$
_authorizationRepository2 J
;J K
private 
readonly 
IConfiguration '
_configuration( 6
;6 7
private 
readonly 
IUserRepository (
_userRepository) 8
;8 9
public  
AuthorizationUseCase #
(# $$
IAuthorizationRepository$ <#
authorizationRepository= T
,T U
IConfigurationV d
configuratione r
,r s
IUserRepository	t 
userRepository
 
)
 
{ 	$
_authorizationRepository $
=% &#
authorizationRepository' >
;> ?
_configuration 
= 
configuration *
;* +
_userRepository 
= 
userRepository ,
;, -
} 	
public'' 
async'' 
Task'' 
<'' 
ResponseDTO'' %
>''% &&
GenerateRefreshAccessToken''' A
(''A B
TokenDTO''B J
request''K R
)''R S
{(( 	
ResponseDTO)) 
response))  
=))! "
new))# &
ResponseDTO))' 2
())2 3
)))3 4
;))4 5
try++ 
{,, 
var.. 
	allTokens.. 
=.. 
await..  %$
_authorizationRepository..& >
...> ?
GetAllAsync..? J
(..J K
)..K L
;..L M
var// 
refreshTokenExpired// '
=//( )
	allTokens//* 3
.//3 4
FirstOrDefault//4 B
(//B C
x//C D
=>//E G
x//H I
.//I J
RefreshToken//J V
==//W Y
request//Z a
.//a b
RefreshToken//b n
&&//o q
x//r s
.//s t
IsValid//t {
==//| ~
true	// 
)
// 
;
// 
if00 
(00 
refreshTokenExpired00 '
==00( *
null00+ /
)00/ 0
{11 
response22 
.22 
	IsExitoso22 &
=22' (
false22) .
;22. /
response33 
.33 
ErrorMessages33 *
.33* +
Add33+ .
(33. /
$str33/ V
)33V W
;33W X
response44 
.44 

StatusCode44 '
=44( )
HttpStatusCode44* 8
.448 9

BadRequest449 C
;44C D
return55 
response55 #
;55# $
}66 
var88 
tokenHandler88  
=88! "
new88# &#
JwtSecurityTokenHandler88' >
(88> ?
)88? @
;88@ A
var99 
expiredToken99  
=99! "
tokenHandler99# /
.99/ 0
ReadJwtToken990 <
(99< =
request99= D
.99D E
AccessToken99E P
)99P Q
;99Q R
if:: 
(:: 
expiredToken::  
.::  !
ValidTo::! (
>::) *
DateTime::+ 3
.::3 4
UtcNow::4 :
)::: ;
{;; 
response<< 
.<< 
	IsExitoso<< &
=<<' (
false<<) .
;<<. /
response== 
.== 
Mensaje== $
===% &
$str==' A
;==A B
response>> 
.>> 

StatusCode>> '
=>>( )
HttpStatusCode>>* 8
.>>8 9

BadRequest>>9 C
;>>C D
return?? 
response?? #
;??# $
}@@ 
varBB 
refreshTokenCreatedBB '
=BB( )
TokenHelperBB* 5
.BB5 6 
GenerateRefreshTokenBB6 J
(BBJ K
)BBK L
;BBL M
varEE 
userEE 
=EE 
awaitEE  
_userRepositoryEE! 0
.EE0 1
GetByIdAsyncEE1 =
(EE= >
intEE> A
.EEA B
ParseEEB G
(EEG H
refreshTokenExpiredEEH [
.EE[ \
	UsuarioIdEE\ e
!EEe f
)EEf g
)EEg h
;EEh i
stringGG 
	secretKeyGG  
=GG! "
_configurationGG# 1
.GG1 2
GetValueGG2 :
<GG: ;
stringGG; A
>GGA B
(GGB C
$strGGC W
)GGW X
!GGX Y
;GGY Z
intHH 
accessTokenTimeHH #
=HH$ %
intHH& )
.HH) *
ParseHH* /
(HH/ 0
_configurationHH0 >
.HH> ?
GetValueHH? G
<HHG H
stringHHH N
>HHN O
(HHO P
$strHHP m
)HHm n
!HHn o
)HHo p
;HHp q
varII 
tokenCreatedII  
=II! "
TokenHelperII# .
.II. /
GenerateAccessTokenII/ B
(IIB C
userIIC G
,IIG H
	secretKeyIII R
,IIR S
accessTokenTimeIIT c
)IIc d
;IId e
refreshTokenExpiredLL #
.LL# $
ExpirationDateLL$ 2
=LL3 4
DateTimeLL5 =
.LL= >
MinValueLL> F
;LLF G
varPP 
updateTokenPP 
=PP  !
awaitPP" '$
_authorizationRepositoryPP( @
.PP@ A
UpdateAsyncPPA L
(PPL M
refreshTokenExpiredPPM `
)PP` a
;PPa b
intRR 
refreshTokenTimeRR $
=RR% &
intRR' *
.RR* +
ParseRR+ 0
(RR0 1
_configurationRR1 ?
.RR? @
GetValueRR@ H
<RRH I
stringRRI O
>RRO P
(RRP Q
$strRRQ o
)RRo p
!RRp q
)RRq r
;RRr s
responseSS 
=SS 
awaitSS  
TokenHelperSS! ,
.SS, -
SaveRefreshTokenSS- =
(SS= >
userSS> B
.SSB C
IdSSC E
,SSE F
tokenCreatedSSG S
,SSS T
refreshTokenCreatedSSU h
,SSh i
refreshTokenTimeSSj z
,SSz {%
_authorizationRepository	SS| 
)
SS 
;
SS 
}TT 
catchUU 
(UU 
	ExceptionUU 
exUU 
)UU  
{VV 
responseWW 
.WW 
	IsExitosoWW "
=WW# $
falseWW% *
;WW* +
responseXX 
.XX 
MensajeXX  
=XX! ""
ExceptionMessageHelperXX# 9
.XX9 :
GetExceptionMessageXX: M
(XXM N
exXXN P
)XXP Q
;XXQ R
responseYY 
.YY 

StatusCodeYY #
=YY$ %
HttpStatusCodeYY& 4
.YY4 5

BadRequestYY5 ?
;YY? @
}ZZ 
return\\ 
response\\ 
;\\ 
}]] 	
}__ 
}aa ๐
ฑD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\Mapping\AutoMappingProfile.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &
Mapping& -
{ 
public

 

class

 
AutoMappingProfile

 #
:

$ %
Profile

& -
{ 
public 
AutoMappingProfile !
(! "
)" #
{ 	
	CreateMap 
< 

Portafolio  
,  !
PortafolioDTO" /
>/ 0
(0 1
)1 2
.2 3
	ForMember3 <
(< =
x= >
=>? A
xB C
.C D

ListaDatosD N
,N O
listP T
=>U W
listX \
.\ ]
MapFrom] d
(d e
ListaDatosMAPe r
)r s
)s t
;t u
	CreateMap 
< 
PortafolioDTO #
,# $

Portafolio% /
>/ 0
(0 1
)1 2
;2 3
	CreateMap 
< 

Portafolio  
,  !
PortafolioCreateDTO" 5
>5 6
(6 7
)7 8
.8 9

ReverseMap9 C
(C D
)D E
;E F
	CreateMap 
< 

Portafolio  
,  !
PortafolioUpdateDTO" 5
>5 6
(6 7
)7 8
.8 9

ReverseMap9 C
(C D
)D E
;E F
	CreateMap 
< 
Usuario 
, 
UserDTO &
>& '
(' (
)( )
.) *

ReverseMap* 4
(4 5
)5 6
;6 7
} 	
public 
List 
< 
ListaDatosDTO !
>! "
ListaDatosMAP# 0
(0 1

Portafolio1 ;

portafolio< F
,F G
PortafolioDTOH U
portafolioDtoV c
)c d
{ 	
var 
source 
= 
JsonConvert $
.$ %
DeserializeObject% 6
<6 7
List7 ;
<; <
ListaDatosDTO< I
>I J
>J K
(K L

portafolioL V
.V W

ListaDatosW a
!a b
)b c
;c d
return 
source 
! 
; 
} 	
} 
}   ํ
ณD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\Interfaces\User\IUserUseCase.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &

Interfaces& 0
.0 1
User1 5
{ 
public

 

	interface

 
IUserUseCase

 !
{ 
Task 
< 
ResponseDTO 
> 
Login 
(  
LoginRequestDTO  /
request0 7
)7 8
;8 9
Task 
< 
ResponseDTO 
> 
Register "
(" #
RegistroRequestDTO# 5
request6 =
)= >
;> ?
} 
} 
ฝD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\Interfaces\Portfolio\IPortfolioUseCase.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &

Interfaces& 0
.0 1
	Portfolio1 :
{ 
public 

	interface 
IPortfolioUseCase &
{ 
Task 
< 
ResponseDTO 
> 
GetAllPortfolio )
() *
)* +
;+ ,
Task 
< 
ResponseDTO 
> 
GetPortfolioByDate ,
(, -
string- 3
positionDate4 @
)@ A
;A B
Task   
<   
ResponseDTO   
>   
GetPortfolioById   *
(  * +
int  + .
id  / 1
)  1 2
;  2 3
Task'' 
<'' 
ResponseDTO'' 
>'' 
CreatePortfolio'' )
('') *
PortafolioCreateDTO''* =
request''> E
)''E F
;''F G
Task// 
<// 
ResponseDTO// 
>// 
UpdatePortfolio// )
(//) *
int//* -
portafolioId//. :
,//: ;
PortafolioUpdateDTO//< O
request//P W
)//W X
;//X Y
Task66 
<66 
ResponseDTO66 
>66 
DeletePortfolio66 )
(66) *
int66* -
id66. 0
)660 1
;661 2
Task== 
<== 
ResponseDTO== 
>== 
	ExcelLoad== #
(==# $
	IFormFile==$ -
file==. 2
)==2 3
;==3 4
TaskDD 
<DD 
ResponseDTODD 
>DD 

GetFileCSVDD $
(DD$ %
stringDD% +
fileDateDD, 4
)DD4 5
;DD5 6
}FF 
}HH ํ

ถD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\Interfaces\User\IUserRepository.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &

Interfaces& 0
.0 1
User1 5
{ 
public		 

	interface		 
IUserRepository		 $
{

 
Task 
< 
int 
> 
AddAsync 
( 
Usuario "
entity# )
)) *
;* +
Task 
< 
bool 
> 
DeleteAsync 
( 
int "
id# %
)% &
;& '
Task 
< 
IEnumerable 
< 
Usuario  
>  !
>! "
GetAllAsync# .
(. /
)/ 0
;0 1
Task   
<   
Usuario   
>   
GetByIdAsync   "
(  " #
int  # &
id  ' )
)  ) *
;  * +
Task"" 
<"" 
bool"" 
>"" 
UpdateAsync"" 
("" 
Usuario"" &
entity""' -
)""- .
;"". /
}$$ 
}&& ุ
ภD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\Interfaces\Portfolio\IPortfolioRepository.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &

Interfaces& 0
.0 1
	Portfolio1 :
{ 
public

 

	interface

  
IPortfolioRepository

 )
{ 
Task 
< 
IEnumerable 
< 

Portafolio #
># $
>$ %
GetAllAsync& 1
(1 2
List2 6
<6 7
object7 =
>= >
?> ?
whereFilter@ K
=L M
nullN R
)R S
;S T
Task 
< 

Portafolio 
> 
GetByIdAsync %
(% &
int& )
id* ,
), -
;- .
Task   
<   
int   
>   
AddAsync   
(   

Portafolio   %
entity  & ,
)  , -
;  - .
Task'' 
<'' 
bool'' 
>'' 
UpdateAsync'' 
('' 

Portafolio'' )
entity''* 0
)''0 1
;''1 2
Task.. 
<.. 
bool.. 
>.. 
DeleteAsync.. 
(.. 
int.. "
id..# %
)..% &
;..& '
Task44 
<44 
IEnumerable44 
<44 
SubPortafolios44 '
>44' (
>44( )$
GetAllSubPortfoliosAsync44* B
(44B C
)44C D
;44D E
Task;; 
<;; 
List;; 
<;; 
string;; 
>;; 
>;; 
SavePortfoliosList;; -
(;;- .
List;;. 2
<;;2 3

Portafolio;;3 =
>;;= >
portafoliosList;;? N
);;N O
;;;O P
TaskEE 
<EE 
boolEE 
>EE 
SaveFileBase64EE !
(EE! "
stringEE" (
originalNameEE) 5
,EE5 6
stringEE7 =
compoundNameEE> J
,EEJ K
byteEEL P
[EEP Q
]EEQ R
stringBase64EES _
,EE_ `
stringEEa g
origenEEh n
)EEn o
;EEo p
TaskLL 
<LL 
ResponseDTOLL 
>LL 
ReadOracleBLOBLL (
(LL( )
stringLL) /
fileDateLL0 8
)LL8 9
;LL9 :
}NN 
}PP 
ลD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\Interfaces\Authorization\IAuthorizationUseCase.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &

Interfaces& 0
.0 1
Authorization1 >
{ 
public

 

	interface

 !
IAuthorizationUseCase

 *
{ 
Task 
< 
ResponseDTO 
> &
GenerateRefreshAccessToken 4
(4 5
TokenDTO5 =
request> E
)E F
;F G
} 
} 
ศD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\Interfaces\Authorization\IAuthorizationRepository.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &

Interfaces& 0
.0 1
Authorization1 >
{ 
public		 

	interface		 $
IAuthorizationRepository		 -
{

 
Task 
< 
int 
> 
AddAsync 
( 
Token  
entity! '
)' (
;( )
Task 
< 
bool 
> 
DeleteAsync 
( 
int "
id# %
)% &
;& '
Task 
< 
IEnumerable 
< 
Token 
> 
>  
GetAllAsync! ,
(, -
)- .
;. /
Task   
<   
Token   
>   
GetByIdAsync    
(    !
int  ! $
tokenId  % ,
)  , -
;  - .
Task'' 
<'' 
bool'' 
>'' 
UpdateAsync'' 
('' 
Token'' $
entity''% +
)''+ ,
;'', -
})) 
}++ ส>
ชD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\Helpers\TokenHelper.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &
Helpers& -
{ 
public 

class 
TokenHelper 
{ 
public 
static 
string 
GenerateAccessToken 0
(0 1
Usuario1 8
user9 =
,= >
string? E
tokenSecretKeyF T
,T U
intV Y
accessTokenTimeZ i
)i j
{ 	
var 
key 
= 
Encoding 
. 
ASCII $
.$ %
GetBytes% -
(- .
tokenSecretKey. <
)< =
;= >
var 
claims 
= 
new 
ClaimsIdentity +
(+ ,
), -
;- .
claims 
. 
AddClaim 
( 
new 
Claim  %
(% &#
JwtRegisteredClaimNames& =
.= >
Sub> A
,A B
userC G
.G H
IdH J
.J K
ToStringK S
(S T
)T U
)U V
)V W
;W X
claims 
. 
AddClaim 
( 
new 
Claim  %
(% &#
JwtRegisteredClaimNames& =
.= >
Iat> A
,A B
DateTimeC K
.K L
UtcNowL R
.R S
ToStringS [
([ \
)\ ]
)] ^
)^ _
;_ `
claims   
.   
AddClaim   
(   
new   
Claim    %
(  % &

ClaimTypes  & 0
.  0 1
Name  1 5
,  5 6
user  7 ;
.  ; <
UserName  < D
)  D E
)  E F
;  F G
claims!! 
.!! 
AddClaim!! 
(!! 
new!! 
Claim!!  %
(!!% &

ClaimTypes!!& 0
.!!0 1
Role!!1 5
,!!5 6
user!!7 ;
.!!; <
Rol!!< ?
)!!? @
)!!@ A
;!!A B
var## 
tokenCredentials##  
=##! "
new### &
SigningCredentials##' 9
(##9 :
new$$  
SymmetricSecurityKey$$ (
($$( )
key$$) ,
)$$, -
,$$- .
SecurityAlgorithms%% "
.%%" #
HmacSha256Signature%%# 6
)&& 
;&& 
var(( 
tokenDescriptor(( 
=((  !
new((" %#
SecurityTokenDescriptor((& =
{)) 
Subject** 
=** 
claims**  
,**  !
Expires++ 
=++ 
DateTime++ "
.++" #
UtcNow++# )
.++) *

AddMinutes++* 4
(++4 5
accessTokenTime++5 D
)++D E
,++E F
SigningCredentials,, "
=,,# $
tokenCredentials,,% 5
,,,5 6
}-- 
;-- 
var// 
tokenHandler// 
=// 
new// "#
JwtSecurityTokenHandler//# :
(//: ;
)//; <
;//< =
var00 
token00 
=00 
tokenHandler00 $
.00$ %
CreateToken00% 0
(000 1
tokenDescriptor001 @
)00@ A
;00A B
var11 
tokenCreated11 
=11 
tokenHandler11 +
.11+ ,

WriteToken11, 6
(116 7
token117 <
)11< =
;11= >
return33 
tokenCreated33 
;33  
}44 	
public:: 
static:: 
string::  
GenerateRefreshToken:: 1
(::1 2
)::2 3
{;; 	
var<< 
content<< 
=<< 
new<< 
byte<< "
[<<" #
$num<<# %
]<<% &
;<<& '
string== 
refreshToken== 
===  !
string==" (
.==( )
Empty==) .
;==. /
using>> 
(>> 
var>> 
rng>> 
=>> !
RandomNumberGenerator>> 2
.>>2 3
Create>>3 9
(>>9 :
)>>: ;
)>>; <
{?? 
rng@@ 
.@@ 
GetBytes@@ 
(@@ 
content@@ $
)@@$ %
;@@% &
refreshTokenAA 
=AA 
ConvertAA &
.AA& '
ToBase64StringAA' 5
(AA5 6
contentAA6 =
)AA= >
;AA> ?
}BB 
returnDD 
refreshTokenDD 
;DD  
}EE 	
publicOO 
staticOO 
asyncOO 
TaskOO  
<OO  !
ResponseDTOOO! ,
>OO, -
SaveRefreshTokenOO. >
(OO> ?
intOO? B
userIdOOC I
,OOI J
stringOOK Q
accessTokenOOR ]
,OO] ^
stringOO_ e
refreshTokenOOf r
,OOr s
intOOt w
refreshTokenTime	OOx 
,
OO &
IAuthorizationRepository
OO ข%
authorizationRepository
OOฃ บ
)
OOบ ป
{PP 	
ResponseDTOQQ 
responseQQ  
=QQ! "
newQQ# &
ResponseDTOQQ' 2
(QQ2 3
)QQ3 4
;QQ4 5
trySS 
{TT 
varUU !
historialRefreshTokenUU )
=UU* +
newUU, /
TokenUU0 5
{VV 
	UsuarioIdWW 
=WW 
userIdWW  &
.WW& '
ToStringWW' /
(WW/ 0
)WW0 1
,WW1 2
AccessTokenXX 
=XX  !
accessTokenXX" -
,XX- .
RefreshTokenYY  
=YY! "
refreshTokenYY# /
,YY/ 0
ExpirationDateZZ "
=ZZ# $
DateTimeZZ% -
.ZZ- .
UtcNowZZ. 4
.ZZ4 5

AddMinutesZZ5 ?
(ZZ? @
refreshTokenTimeZZ@ P
)ZZP Q
,ZZQ R
}\\ 
;\\ 
var^^ 
token^^ 
=^^ 
await^^ !#
authorizationRepository^^" 9
.^^9 :
AddAsync^^: B
(^^B C!
historialRefreshToken^^C X
)^^X Y
;^^Y Z
response`` 
.`` 
	IsExitoso`` "
=``# $
token``% *
>``+ ,
$num``- .
;``. /
responseaa 
.aa 
Mensajeaa  
=aa! "
responseaa# +
.aa+ ,
	IsExitosoaa, 5
?aa6 7
$straa8 S
:aaT U
$straaV t
;aat u
responsebb 
.bb 
	Resultadobb "
=bb# $
newbb% (
TokenDTObb) 1
{bb2 3
AccessTokenbb4 ?
=bb@ A
accessTokenbbB M
,bbM N
RefreshTokenbbO [
=bb\ ]
refreshTokenbb^ j
}bbk l
;bbl m
responsecc 
.cc 

StatusCodecc #
=cc$ %
HttpStatusCodecc& 4
.cc4 5
OKcc5 7
;cc7 8
}dd 
catchee 
(ee 
	Exceptionee 
exee 
)ee  
{ff 
responsegg 
.gg 
	IsExitosogg "
=gg# $
falsegg% *
;gg* +
responsehh 
.hh 
ErrorMessageshh &
.hh& '
Addhh' *
(hh* +
exhh+ -
.hh- .
Messagehh. 5
)hh5 6
;hh6 7
responseii 
.ii 

StatusCodeii #
=ii$ %
HttpStatusCodeii& 4
.ii4 5

BadRequestii5 ?
;ii? @
}jj 
returnll 
responsell 
;ll 
}mm 	
}oo 
}qq ่

ตD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\Helpers\ExceptionMessageHelper.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &
Helpers& -
{ 
public 

class "
ExceptionMessageHelper '
{ 
public 
static 
string 
GetExceptionMessage 0
(0 1
	Exception1 :
	exception; D
)D E
{ 	
string 
message 
= 
	exception &
.& '
Message' .
+/ 0
$str1 4
;4 5
while 
( 
	exception 
? 
. 
InnerException ,
!=- /
null0 4
)4 5
{ 
message 
+= 
	exception $
.$ %
InnerException% 3
?3 4
.4 5
Message5 <
;< =
	exception 
= 
	exception %
.% &
InnerException& 4
!4 5
;5 6
} 
return 
message 
; 
} 	
} 
} ต
จD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\DTOs\User\UserDTO.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &
DTOs& *
.* +
User+ /
{ 
public 

class 
UserDTO 
{ 
public 
string 
UserName 
{  
get! $
;$ %
set& )
;) *
}+ ,
=- .
string/ 5
.5 6
Empty6 ;
;; <
public		 
string		 
Nombre		 
{		 
get		 "
;		" #
set		$ '
;		' (
}		) *
=		+ ,
string		- 3
.		3 4
Empty		4 9
;		9 :
} 
} จ
ฉD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\DTOs\User\TokenDTO.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &
DTOs& *
.* +
User+ /
{ 
public 

class 
TokenDTO 
{ 
[		 	
Required			 
]		 
public

 
string

 
AccessToken

 !
{

" #
get

$ '
;

' (
set

) ,
;

, -
}

. /
=

0 1
string

2 8
.

8 9
Empty

9 >
;

> ?
[ 	
Required	 
] 
public 
string 
RefreshToken "
{# $
get% (
;( )
set* -
;- .
}/ 0
=1 2
string3 9
.9 :
Empty: ?
;? @
} 
} ๖
ณD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\DTOs\User\RegistroRequestDTO.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &
DTOs& *
.* +
User+ /
{ 
public 

class 
RegistroRequestDTO #
{ 
[		 	
Required			 
]		 
public

 
string

 
UserName

 
{

  
get

! $
;

$ %
set

& )
;

) *
}

+ ,
=

- .
string

/ 5
.

5 6
Empty

6 ;
;

; <
[ 	
Required	 
] 
public 
string 
Nombre 
{ 
get "
;" #
set$ '
;' (
}) *
=+ ,
string- 3
.3 4
Empty4 9
;9 :
[ 	
Required	 
] 
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
=- .
string/ 5
.5 6
Empty6 ;
;; <
[ 	
Required	 
] 
public 
string 
Rol 
{ 
get 
;  
set! $
;$ %
}& '
=( )
string* 0
.0 1
Empty1 6
;6 7
} 
} ฝ
ฐD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\DTOs\User\LoginRequestDTO.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &
DTOs& *
.* +
User+ /
{ 
public 

class 
LoginRequestDTO  
{ 
public 
string 
? 
Username 
{  !
get" %
;% &
set' *
;* +
}, -
public		 
string		 
?		 
Password		 
{		  !
get		" %
;		% &
set		' *
;		* +
}		, -
} 
} ใ
งD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\DTOs\ResponseDTO.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &
DTOs& *
{		 
public 

class 
ResponseDTO 
{ 
public 
HttpStatusCode 

StatusCode (
{) *
get+ .
;. /
set0 3
;3 4
}5 6
public 
bool 
	IsExitoso 
{ 
get  #
;# $
set% (
;( )
}* +
=, -
false. 3
;3 4
public 
List 
< 
string 
> 
ErrorMessages )
{* +
get, /
;/ 0
set1 4
;4 5
}6 7
=8 9
new: =
List> B
<B C
stringC I
>I J
(J K
)K L
;L M
public 
object 
? 
	Resultado  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
string 
? 
Mensaje 
{  
get! $
;$ %
set& )
;) *
}+ ,
} 
} ฆ
นD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\DTOs\Portfolio\PortafolioUpdateDTO.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &
DTOs& *
.* +
	Portfolio+ 4
{ 
public 

class 
PortafolioUpdateDTO $
{ 
public		 
string		 
?		 

ListaDatos		 !
{		" #
get		$ '
;		' (
set		) ,
;		, -
}		. /
} 
} ฬ
ณD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\DTOs\Portfolio\PortafolioDTO.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &
DTOs& *
.* +
	Portfolio+ 4
{ 
public 

class 
PortafolioDTO 
{ 
public		 
int		 
IdPortafolio		 
{		  !
get		" %
;		% &
set		' *
;		* +
}		, -
[

 	
Required

	 
]

 
public 
string 
? 

F_Posicion !
{" #
get$ '
;' (
set) ,
;, -
}. /
[ 	
Required	 
] 
[ 	
	MaxLength	 
( 
$num 
) 
] 
public 
string 
? 
NombrePortafolio '
{( )
get* -
;- .
set/ 2
;2 3
}4 5
public 
string 
? 
SubPortafolio $
{% &
get' *
;* +
set, /
;/ 0
}1 2
public 
int 
No_Envio 
{ 
get !
;! "
set# &
;& '
}( )
public 
DateTime 
FechaCreacion %
{& '
get( +
;+ ,
set- 0
;0 1
}2 3
public 
DateTime 
FechaModificacion )
{* +
get, /
;/ 0
set1 4
;4 5
}6 7
[ 	
Required	 
] 
public 
int 
SubPortafolioId "
{# $
get% (
;( )
set* -
;- .
}/ 0
public 
dynamic 
? 

ListaDatos "
{# $
get% (
;( )
set* -
;- .
}/ 0
} 
}!! ๓

นD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\DTOs\Portfolio\PortafolioCreateDTO.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &
DTOs& *
.* +
	Portfolio+ 4
{ 
public 

class 
PortafolioCreateDTO $
{ 
public 
string 
? 

F_Posicion !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 
string 
? 

ListaDatos !
{" #
get$ '
;' (
set) ,
;, -
}. /
[ 	
Required	 
] 
[ 	
	MaxLength	 
( 
$num 
) 
] 
public 
string 
? 
NombrePortafolio '
{( )
get* -
;- .
set/ 2
;2 3
}4 5
[ 	
Required	 
] 
public 
int 
SubPortafolioId "
{# $
get% (
;( )
set* -
;- .
}/ 0
} 
} พ
ณD:\Banobras\Sistemas .NET\SST3\SIVARMER\TransicionNvaFSW\Trunk\Cรณdigo\RiesgosSimefin_Oracle_2024_05_29\Riesgos.Simefin\Riesgos.Simefin.Application\DTOs\Portfolio\ListaDatosDTO.cs
	namespace 	
Riesgos
 
. 
Simefin 
. 
Application %
.% &
DTOs& *
.* +
	Portfolio+ 4
{ 
public 

class 
ListaDatosDTO 
{ 
public 
string 
? 
Fecha 
{ 
get "
;" #
set$ '
;' (
}) *
public		 
decimal		 
?		 
Valor		 
{		 
get		  #
;		# $
set		% (
;		( )
}		* +
} 
} 